var e;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(e||(e={}));const t=(()=>{function e(e){const t=window[e];return!!t&&(t.setItem("__test__","__test__"),"__test__"===t.getItem("__test__")&&(t.removeItem("__test__"),!t.getItem("__test__")))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var n;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(n||(n={}));const r={[n.Error]:"ERROR",[n.Warn]:"WARNING",[n.Info]:"INFO",[n.Verbose]:"VERBOSE"},o={pii:!1,correlationId:void 0,level:n.Error,log(e,t,n,o=!1){if((!o||this.pii)&&e<=this.level){let o=(new Date).toUTCString()+":"+(this.correlationId?this.correlationId+"-":"")+r[e]+": "+t;n&&(o+="\nstack:\n"+n.stack),console.log(o)}},error(e,t){this.log(n.Error,e,t)},warn(e){this.log(n.Warn,e,null)},info(e){this.log(n.Info,e,null)},verbose(e){this.log(n.Verbose,e,null)},errorPii(e,t){this.log(n.Error,e,t,!0)},warnPii(e){this.log(n.Warn,e,null,!0)},infoPii(e){this.log(n.Info,e,null,!0)},verbosePii(e){this.log(n.Verbose,e,null,!0)}};var i,s,a;!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(i||(i={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(s||(s={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(a||(a={}));class c{constructor(e){if(this._activeRenewals={},this._loginInProgress=!1,this._acquireTokenInProgress=!1,this._renewStates=[],this._openedWindows=[],this._callBackMappedToRenewStates={},this._callBacksMappedToRenewStates={},this._requestType=i.LOGIN,window._adalInstance)return window._adalInstance;this.config={popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:e.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,anonymousEndpoints:[],navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{},...e},o.correlationId=e.correlationId,window._adalInstance=this}login(){if(this._loginInProgress)return void o.info("Login in progress");this._loginInProgress=!0;const t=f(),n=window.location.href;this.config.state=t,this._idTokenNonce=f(),o.verbose("Expected state: "+t+" startPage:"+n),l(e.LOGIN_REQUEST,n),l(e.LOGIN_ERROR,""),l(e.STATE_LOGIN,t,!0),l(e.NONCE_IDTOKEN,this._idTokenNonce,!0),l(e.ERROR,""),l(e.ERROR_DESCRIPTION,"");var r=this._getNavigateUrl("id_token")+"&nonce="+encodeURIComponent(this._idTokenNonce);this.config.displayCall?this.config.displayCall(r):this.config.popUp?(l(e.STATE_LOGIN,""),this._renewStates.push(t),this.registerCallback(t,this.config.clientId,this.config.callback),this._loginPopup(r)):this.promptUser(r)}_openPopup(e,t,n,r){try{const o=window.innerWidth/2-n/2+window.screenX,i=window.innerHeight/2-r/2+window.screenY,s=window.open(e,t,"width="+n+", height="+r+", top="+i+", left="+o);return s.focus&&s.focus(),s}catch(e){return o.warn("Error opening popup, "+e.message),this._loginInProgress=!1,this._acquireTokenInProgress=!1,null}}_handlePopupError(t,n,r,i,s){o.warn(i),l(e.ERROR,r),l(e.ERROR_DESCRIPTION,i),l(e.LOGIN_ERROR,s),n&&this._activeRenewals[n]&&(this._activeRenewals[n]=null),this._loginInProgress=!1,this._acquireTokenInProgress=!1,t&&t(i,null,r)}_loginPopup(e,t,n){var r=this._openPopup(e,"login",483,600),i=n||this.config.callback;if(!r){var s="Popup Window is null. This can happen if you are using IE";return void this._handlePopupError(i,t,"Error opening popup",s,s)}this._openedWindows.push(r);const a=this.config.redirectUri.split("#")[0];var c=setInterval(()=>{if(!r||r.closed||void 0===r.closed){var e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return this._handlePopupError(i,t,"Popup Window closed",e,e),void clearInterval(c)}try{var n=r.location;if(-1!=encodeURI(n.href).indexOf(encodeURI(a)))return this.handleWindowCallback(n.hash),clearInterval(c),this._loginInProgress=!1,this._acquireTokenInProgress=!1,o.info("Closing popup window"),this._openedWindows=[],void r.close()}catch(e){}},1)}loginInProgress(){return this._loginInProgress}_hasResource(t){var n=d(e.TOKEN_KEYS);return!u(n)&&n.indexOf(t+"|")>-1}getCachedToken(t){if(!this._hasResource(t))return;const n=d(e.ACCESS_TOKEN_KEY+t),r=d(e.EXPIRATION_KEY+t);if(r&&r>g()+this.config.expireOffsetSeconds)return n;l(e.ACCESS_TOKEN_KEY+t,""),l(e.EXPIRATION_KEY+t,0)}getCachedUser(){return this.getUser()}registerCallback(e,t,n){this._activeRenewals[t]=e,this._callBacksMappedToRenewStates[e]||(this._callBacksMappedToRenewStates[e]=[]),this._callBacksMappedToRenewStates[e].push(n),this._callBackMappedToRenewStates[e]||(this._callBackMappedToRenewStates[e]=(n,r,i,s)=>{this._activeRenewals[t]=null;for(var a=0;a<this._callBacksMappedToRenewStates[e].length;++a)try{this._callBacksMappedToRenewStates[e][a](n,r,i,s)}catch(i){o.warn(i)}this._callBacksMappedToRenewStates[e]=null,this._callBackMappedToRenewStates[e]=null})}_renewToken(t,n,r="token"){o.info("renewToken is called for resource:"+t);var i=this._addAdalFrame("adalRenewFrame"+t),a=f()+"|"+t;this.config.state=a,this._renewStates.push(a),o.verbose("Renew token Expected state: "+a);var c=this._urlRemoveQueryStringParameter(this._getNavigateUrl(r,t),"prompt");r===s.ID_TOKEN&&(this._idTokenNonce=f(),l(e.NONCE_IDTOKEN,this._idTokenNonce,!0),c+="&nonce="+encodeURIComponent(this._idTokenNonce)),c=this._addHintParameters(c+="&prompt=none"),this.registerCallback(a,t,n),o.verbosePii("Navigate to:"+c),i.src="about:blank",this._loadFrameTimeout(c,"adalRenewFrame"+t,t)}_renewIdToken(t,n){o.info("renewIdToken is called");let r=this._addAdalFrame("adalIdTokenFrame"),i=f()+"|"+this.config.clientId;this._idTokenNonce=f(),l(e.NONCE_IDTOKEN,this._idTokenNonce,!0),this.config.state=i,this._renewStates.push(i),o.verbose("Renew Idtoken Expected state: "+i);let s=n||this.config.clientId,a=this._urlRemoveQueryStringParameter(this._getNavigateUrl(n=n||"id_token",s),"prompt");a+="&prompt=none",a=this._addHintParameters(a),a+="&nonce="+encodeURIComponent(this._idTokenNonce),this.registerCallback(i,this.config.clientId,t),o.verbosePii("Navigate to:"+a),r.src="about:blank",this._loadFrameTimeout(a,"adalIdTokenFrame",this.config.clientId)}_urlContainsQueryStringParameter(e,t){return new RegExp("[\\?&]"+e+"=").test(t)}_urlRemoveQueryStringParameter(e,t){var n=new RegExp("(\\&"+t+"=)[^&]+");return e=e.replace(n,""),n=new RegExp("("+t+"=)[^&]+&"),e=e.replace(n,""),n=new RegExp("("+t+"=)[^&]+"),e.replace(n,"")}_loadFrameTimeout(t,n,r){o.verbose("Set loading state to pending for: "+r),l(e.RENEW_STATUS+r,a.InProgress),this._loadFrame(t,n),setTimeout(()=>{if(d(e.RENEW_STATUS+r)===a.InProgress){o.verbose("Loading frame has timed out after: "+this.config.loadFrameTimeout/1e3+" seconds for resource "+r);var t=this._activeRenewals[r];t&&this._callBackMappedToRenewStates[t]&&this._callBackMappedToRenewStates[t]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),l(e.RENEW_STATUS+r,a.Canceled)}},this.config.loadFrameTimeout)}_loadFrame(e,t){o.info("LoadFrame: "+t),setTimeout(()=>{const n=this._addAdalFrame(t);n.src&&"about:blank"!==n.src||(n.src=e,this._loadFrame(e,t))},500)}acquireToken(e,t){if(!e){const e="resource is required";return o.warn(e),void t(e,null,e)}var n=this.getCachedToken(e);if(n)return o.info("Token is already in cache for resource:"+e),void t(null,n,null);if(!(this._user||this.config.extraQueryParameter&&-1!==this.config.extraQueryParameter.indexOf("login_hint"))){const e="User login is required";return o.warn(e),void t(e,null,e)}this._activeRenewals[e]?this.registerCallback(this._activeRenewals[e],e,t):(this._requestType=i.RENEW_TOKEN,e===this.config.clientId?this._user?(o.verbose("renewing idtoken"),this._renewIdToken(t)):(o.verbose("renewing idtoken and access_token"),this._renewIdToken(t,s.ID_TOKEN)):this._user?(o.verbose("renewing access_token"),this._renewToken(e,t)):(o.verbose("renewing idtoken and access_token"),this._renewToken(e,t,s.ID_TOKEN)))}acquireTokenPopup(e,t,n,r){if(this._canAcquireToken(e)){var s=f()+"|"+e;this.config.state=s,this._renewStates.push(s),this._requestType=i.RENEW_TOKEN,o.verbose("Renew token Expected state: "+s);var a=this._urlRemoveQueryStringParameter(this._getNavigateUrl("token",e),"prompt");if(a+="&prompt=select_account",t&&(a+=t),n&&-1===a.indexOf("&claims"))a+="&claims="+encodeURIComponent(n);else if(n&&-1!==a.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");a=this._addHintParameters(a),this._acquireTokenInProgress=!0,o.info("acquireToken interactive is called for the resource "+e),this.registerCallback(s,e,r),this._loginPopup(a,e,r)}}acquireTokenRedirect(t,n,r){if(!this._canAcquireToken(t))return;const i=f()+"|"+t;this.config.state=i,o.verbose("Renew token Expected state: "+i);var s=this._urlRemoveQueryStringParameter(this._getNavigateUrl("token",t),"prompt");if(s+="&prompt=select_account",n&&(s+=n),r&&-1===s.indexOf("&claims"))s+="&claims="+encodeURIComponent(r);else if(r&&-1!==s.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");s=this._addHintParameters(s),this._acquireTokenInProgress=!0,o.info("acquireToken interactive is called for the resource "+t),l(e.LOGIN_REQUEST,window.location.href),l(e.STATE_RENEW,i,!0),this.promptUser(s)}_canAcquireToken(e){let t;return e?this._user?this._acquireTokenInProgress&&(t="Acquire token interactive is already in progress"):t="User login is required":t="Resource is required",!t||(o.warn(t),this.config.callback(t,null,t),!1)}promptUser(e){e?(o.infoPii("Navigate to:"+e),window.location.replace(e)):o.info("Navigate url is empty")}clearCache(){l(e.LOGIN_REQUEST,""),l(e.SESSION_STATE,""),l(e.STATE_LOGIN,""),l(e.STATE_RENEW,""),this._renewStates=[],l(e.NONCE_IDTOKEN,""),l(e.IDTOKEN,""),l(e.ERROR,""),l(e.ERROR_DESCRIPTION,""),l(e.LOGIN_ERROR,""),l(e.LOGIN_ERROR,"");var t=d(e.TOKEN_KEYS);if(!u(t)){t=t.split("|");for(var n=0;n<t.length&&""!==t[n];n++)l(e.ACCESS_TOKEN_KEY+t[n],""),l(e.EXPIRATION_KEY+t[n],0)}l(e.TOKEN_KEYS,"")}clearCacheForResource(t){l(e.STATE_RENEW,""),l(e.ERROR,""),l(e.ERROR_DESCRIPTION,""),this._hasResource(t)&&(l(e.ACCESS_TOKEN_KEY+t,""),l(e.EXPIRATION_KEY+t,0))}logOut(){let e;if(this.clearCache(),this._user=null,this.config.logOutUri)e=this.config.logOutUri;else{let t="";this.config.postLogoutRedirectUri&&(t="post_logout_redirect_uri="+encodeURIComponent(this.config.postLogoutRedirectUri)),e=this.config.instance+this.config.tenant+"/oauth2/logout?"+t}o.infoPii("Logout navigate to: "+e),this.promptUser(e)}getUser(){if(!this._user){const t=d(e.IDTOKEN);t&&(this._user=this._createUser(t))}return this._user}_addHintParameters(e){if(this._user&&this._user.profile)if(this._user.profile.sid&&-1!==e.indexOf("&prompt=none"))this._urlContainsQueryStringParameter("sid",e)||(e+="&sid="+encodeURIComponent(this._user.profile.sid));else if(this._user.profile.upn&&(this._urlContainsQueryStringParameter("login_hint",e)||(e+="&login_hint="+encodeURIComponent(this._user.profile.upn)),!this._urlContainsQueryStringParameter("domain_hint",e)&&this._user.profile.upn.indexOf("@")>-1)){var t=this._user.profile.upn.split("@");e+="&domain_hint="+encodeURIComponent(t[t.length-1])}return e}_createUser(e){const t=this._extractIdToken(e);if(p(t,"aud"))return t.aud.toLowerCase()===this.config.clientId.toLowerCase()?{userName:t.upn||t.email,profile:t}:void o.warn("IdToken has invalid aud field")}getLoginError(){return d(e.LOGIN_ERROR)}getRequestInfo(e){const t={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:i.UNKNOWN},n=h(_(e));if(!n)return t;if(t.parameters=n,p(n,"error_description")||p(n,"access_token")||p(n,"id_token")){if(t.valid=!0,!n.hasOwnProperty("state"))return o.warn("No state returned"),t;if(o.verbose("State: "+n.state),t.stateResponse=n.state,this._matchState(t))return t;if(!t.stateMatch&&window.parent){t.requestType=this._requestType;for(const e of this._renewStates)if(e===t.stateResponse){t.stateMatch=!0;break}}}return t}_matchState(t){const n=d(e.STATE_LOGIN);if(n)for(const e of n.split("||"))if(e===t.stateResponse)return t.requestType=i.LOGIN,t.stateMatch=!0,!0;const r=d(e.STATE_RENEW);if(r)for(const e of r.split("||"))if(e===t.stateResponse)return t.requestType=i.RENEW_TOKEN,t.stateMatch=!0,!0;return!1}saveTokenFromHash(t){o.info("State status:"+t.stateMatch+"; Request type:"+t.requestType),l(e.ERROR,""),l(e.ERROR_DESCRIPTION,"");var n,r,s=function(e){if(e){var t=e.indexOf("|");if(t>-1&&t+1<e.length)return e.substring(t+1)}return""}(t.stateResponse);t.parameters.hasOwnProperty("error_description")?(o.infoPii("Error :"+t.parameters.error+"; Error description:"+t.parameters.error_description),l(e.ERROR,t.parameters.error),l(e.ERROR_DESCRIPTION,t.parameters.error_description),t.requestType===i.LOGIN&&(this._loginInProgress=!1,l(e.LOGIN_ERROR,t.parameters.error_description))):t.stateMatch?(o.info("State is right"),t.parameters.hasOwnProperty("session_state")&&l(e.SESSION_STATE,t.parameters.session_state),t.parameters.hasOwnProperty("access_token")&&(o.info("Fragment has access token"),this._hasResource(s)||(n=d(e.TOKEN_KEYS)||"",l(e.TOKEN_KEYS,n+s+"|")),l(e.ACCESS_TOKEN_KEY+s,t.parameters.access_token),l(e.EXPIRATION_KEY+s,((r=t.parameters.expires_in)||(r=3599),g()+parseInt(r,10)))),t.parameters.hasOwnProperty("id_token")&&(this._loginInProgress=!1,this._user=this._createUser(t.parameters.id_token),this._user&&this._user.profile?function(t){const n=d(e.NONCE_IDTOKEN);if(n)for(const e of n.split("||"))if(e===t.profile.nonce)return!0;return!1}(this._user)?(l(e.IDTOKEN,t.parameters.id_token),this._hasResource(s=this.config.loginResource?this.config.loginResource:this.config.clientId)||(n=d(e.TOKEN_KEYS)||"",l(e.TOKEN_KEYS,n+s+"|")),l(e.ACCESS_TOKEN_KEY+s,t.parameters.id_token),l(e.EXPIRATION_KEY+s,this._user.profile.exp)):(l(e.LOGIN_ERROR,"Nonce received: "+this._user.profile.nonce+" is not same as requested: "+d(e.NONCE_IDTOKEN)),this._user=null):(t.parameters.error="invalid id_token",t.parameters.error_description="Invalid id_token. id_token: "+t.parameters.id_token,l(e.ERROR,"invalid id_token"),l(e.ERROR_DESCRIPTION,"Invalid id_token. id_token: "+t.parameters.id_token)))):(t.parameters.error="Invalid_state",t.parameters.error_description="Invalid_state. state: "+t.stateResponse,l(e.ERROR,"Invalid_state"),l(e.ERROR_DESCRIPTION,"Invalid_state. state: "+t.stateResponse)),l(e.RENEW_STATUS+s,a.Completed)}getResourceForEndpoint(e){if(this.config.anonymousEndpoints)for(let t=0;t<this.config.anonymousEndpoints.length;t++)if(e.indexOf(this.config.anonymousEndpoints[t])>-1)return;if(this.config.endpoints)for(const t in this.config.endpoints)if(e.indexOf(t)>-1)return this.config.endpoints[t];return e.indexOf("http://")>-1||e.indexOf("https://")>-1?(t=this.config.redirectUri,new URL(e).host===new URL(t).host?this.config.loginResource:void 0):this.config.loginResource;var t}handleWindowCallback(t=window.location.hash){if(function(e){const t=h(_(e));return p(t,"error_description")||p(t,"access_token")||p(t,"id_token")}(t)){let s,a;const c=this._openedWindows[this._openedWindows.length-1];c&&c.opener&&c.opener._adalInstance?(s=c.opener._adalInstance,a=!0):window.parent&&window.parent._adalInstance&&(s=window.parent._adalInstance);let l,_,h,u=s.getRequestInfo(t);l=a||window.parent!==window?s._callBackMappedToRenewStates[u.stateResponse]:s.config.callback,s.saveTokenFromHash(u),u.requestType===i.RENEW_TOKEN&&window.parent?(window.parent!==window?o.verbose("Window is in iframe, acquiring token silently"):o.verbose("acquiring token interactive in progress"),_=u.parameters.access_token||u.parameters.id_token,h="access_token"):u.requestType===i.LOGIN&&(_=u.parameters.id_token,h="id_token");var n=u.parameters.error_description,r=u.parameters.error;try{l&&l(n,_,r,h)}catch(e){o.error("Error occurred in user defined callback function: "+e)}window.parent!==window||a||(s.config.navigateToLoginRequestUrl?window.location.href=d(e.LOGIN_REQUEST):window.location.hash="")}}_getNavigateUrl(e,t){const n=this.config.instance+this.config.tenant+"/oauth2/authorize"+function(e,t,n){if(!t)return"";const r=["?response_type="+e,"client_id="+encodeURIComponent(t.clientId)];n&&r.push("resource="+encodeURIComponent(n)),r.push("redirect_uri="+encodeURIComponent(t.redirectUri)),r.push("state="+encodeURIComponent(t.state)),p(t,"slice")&&r.push("slice="+encodeURIComponent(t.slice)),p(t,"extraQueryParameter")&&r.push(t.extraQueryParameter);const o=t.correlationId||f();return r.push("client-request-id="+encodeURIComponent(o)),r.join("&")}(e,this.config,t);return o.info("Navigate url:"+n),n}_extractIdToken(e){var t=this._decodeJwt(e);if(t)try{var n=this._base64DecodeStringUrlSafe(t.JWSPayload);return n?JSON.parse(n):void o.info("The returned id_token could not be base64 url safe decoded.")}catch(e){o.error("The returned id_token could not be decoded",e)}}_base64DecodeStringUrlSafe(e){return e=e.replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(e)))}_decodeJwt(e){if(!u(e)){var t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(t&&!(t.length<4))return{header:t[1],JWSPayload:t[2],JWSSig:t[3]};o.warn("The returned id_token is not parseable.")}}_addAdalFrame(e){return document.getElementById(e)||(o.info("Add adal frame to document:"+e),document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}}function l(e,n,r=!1){if(r){const r=d(e)||"";t.setItem(e,r+n+"||")}else t.setItem(e,n)}function d(e){return t.getItem(e)}function _(e){return e.indexOf("#/")>-1?e=e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1&&(e=e.substring(1)),e}function h(e){var t,n=/\+/g,r=/([^&=]+)=([^&]*)/g,o=e=>decodeURIComponent(e.replace(n," ")),i={};for(t=r.exec(e);t;)i[o(t[1])]=o(t[2]),t=r.exec(e);return i}function u(e){return void 0===e||!e||0===e.length}function p(e,t){return Object.hasOwnProperty.call(e,t)}function g(){return Math.round(Date.now()/1e3)}function f(){let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let t=e.toString(16);for(;t.length<2;)t="0"+t;return t}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]}export{c as Adal};
//# sourceMappingURL=adal.modern.js.map
