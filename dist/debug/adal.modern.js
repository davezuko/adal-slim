var e;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(e||(e={}));const n=(()=>{function e(e){const n=window[e];return!!n&&(n.setItem("__test__","__test__"),"__test__"===n.getItem("__test__")&&(n.removeItem("__test__"),!n.getItem("__test__")))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var t;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(t||(t={}));const o={[t.Error]:"ERROR",[t.Warn]:"WARNING",[t.Info]:"INFO",[t.Verbose]:"VERBOSE"},r={pii:!1,correlationId:void 0,level:t.Error,log(e,n,t,r=!1){if((!r||this.pii)&&e<=this.level){let r=(new Date).toUTCString()+":"+(this.correlationId?this.correlationId+"-":"")+o[e]+": "+n;t&&(r+="\nstack:\n"+t.stack),console.log(r)}},error(e,n){this.log(t.Error,e,n)},warn(e){this.log(t.Warn,e,null)},info(e){this.log(t.Info,e,null)},verbose(e){this.log(t.Verbose,e,null)},errorPii(e,n){this.log(t.Error,e,n,!0)},warnPii(e){this.log(t.Warn,e,null,!0)},infoPii(e){this.log(t.Info,e,null,!0)},verbosePii(e){this.log(t.Verbose,e,null,!0)}};var i,a,s;function c(n){if(window._adalInstance)return window._adalInstance;let t,o;n=(e=>(e={popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:e.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,anonymousEndpoints:[],navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{},...e},r.correlationId=e.correlationId,e))(n);let c={},l=!1,k=!1,v=[],C=[],K={},b={},P=i.LOGIN;function U(n,t,o,i,a){r.warn(i),u(e.ERROR,o),u(e.ERROR_DESCRIPTION,i),u(e.LOGIN_ERROR,a),t&&c[t]&&(c[t]=null),l=!1,k=!1,n&&n(i,null,o)}function y(t,o,a){var s=function(e,n,t,o){try{const n=window.innerWidth/2-241.5+window.screenX,t=window.innerHeight/2-300+window.screenY,o=window.open(e,"login","width=483, height=600, top="+t+", left="+n);return o.focus&&o.focus(),o}catch(e){r.warn("Error opening popup, "+e.message),l=!1,k=!1}}(t),c=a||n.callback;if(!s){var d="Popup Window is null. This can happen if you are using IE";return void U(c,o,"Error opening popup",d,d)}C.push(s);const p=n.redirectUri.split("#")[0];let u=setInterval(()=>{if(!s||s.closed||void 0===s.closed){let e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return U(c,o,"Popup Window closed",e,e),void clearInterval(u)}try{let n=s.location;if(-1!=encodeURI(n.href).indexOf(encodeURI(p)))return function(n=window.location.hash){if(!_(n))return;let t,o;const a=C[C.length-1];a&&a.opener&&a.opener._adalInstance?(t=a.opener._adalInstance,o=!0):window.parent&&window.parent._adalInstance&&(t=window.parent._adalInstance);let s,c,l,d=t.getRequestInfo(n);s=o||window.parent!==window?t._callBackMappedToRenewStates[d.stateResponse]:t.config.callback,t.saveTokenFromHash(d),d.requestType===i.RENEW_TOKEN&&window.parent?(window.parent!==window?r.verbose("Window is in iframe, acquiring token silently"):r.verbose("acquiring token interactive in progress"),c=d.parameters.access_token||d.parameters.id_token,l="access_token"):d.requestType===i.LOGIN&&(c=d.parameters.id_token,l="id_token");let p=d.parameters.error_description,u=d.parameters.error;try{s&&s(p,c,u,l)}catch(e){r.error("Error occurred in user defined callback function: "+e)}window.parent!==window||o||(t.config.navigateToLoginRequestUrl?window.location.href=g(e.LOGIN_REQUEST):window.location.hash="")}(n.hash),clearInterval(u),l=!1,k=!1,r.info("Closing popup window"),C=[],void s.close()}catch(e){}},1)}function A(){if(!t){const n=g(e.IDTOKEN);n&&(t=F(n))}return t}function L(t){if(!E(t))return;const o=g(e.ACCESS_TOKEN_KEY+t),r=g(e.EXPIRATION_KEY+t);if(r&&r>S()+n.expireOffsetSeconds)return o;u(e.ACCESS_TOKEN_KEY+t,""),u(e.EXPIRATION_KEY+t,0)}function W(e,n,t){c[n]=e,b[e]||(b[e]=[]),b[e].push(t),K[e]||(K[e]=(t,o,i,a)=>{c[n]=null;for(var s=0;s<b[e].length;++s)try{b[e][s](t,o,i,a)}catch(i){r.warn(i)}b[e]=null,K[e]=null})}function x(t,i,s="token"){r.info("renewToken is called for resource:"+t);let c=Q("adalRenewFrame"+t),l=m()+"|"+t;n.state=l,v.push(l),r.verbose("Renew token Expected state: "+l);let d=p(M(s,t),"prompt");s===a.ID_TOKEN&&(o=m(),u(e.NONCE_IDTOKEN,o,!0),d+="&nonce="+encodeURIComponent(o)),d+="&prompt=none",d=Y(d),W(l,t,i),r.verbosePii("Navigate to:"+d),c.src="about:blank",D(d,"adalRenewFrame"+t,t)}function q(t,i){let a=Q("adalIdTokenFrame"),s=m()+"|"+n.clientId;o=m(),u(e.NONCE_IDTOKEN,o,!0),n.state=s,v.push(s),r.verbose("Renew Idtoken Expected state: "+s);let c=i||n.clientId,l=p(M(i=i||"id_token",c),"prompt");l=Y(l+"&prompt=none"),l+="&nonce="+encodeURIComponent(o),W(s,n.clientId,t),r.verbosePii("Navigate to:"+l),a.src="about:blank",D(l,"adalIdTokenFrame",n.clientId)}function D(t,o,i){r.verbose("Set loading state to pending for: "+i),u(e.RENEW_STATUS+i,s.InProgress),function e(n,t){r.info("LoadFrame: "+t),setTimeout(()=>{const o=Q(t);o.src&&"about:blank"!==o.src||(o.src=n,e(n,t))},500)}(t,o),setTimeout(()=>{if(g(e.RENEW_STATUS+i)===s.InProgress){r.verbose("Loading frame has timed out after: "+n.loadFrameTimeout/1e3+" seconds for resource "+i);var t=c[i];t&&K[t]&&K[t]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),u(e.RENEW_STATUS+i,s.Canceled)}},n.loadFrameTimeout)}function G(e){e?(r.infoPii("Navigate to:"+e),window.location.replace(e)):r.info("Navigate url is empty")}function Y(e){if(!t||!t.profile)return e;if(t.profile.sid&&-1!==e.indexOf("&prompt=none"))d("sid",e)||(e+="&sid="+encodeURIComponent(t.profile.sid));else if(t.profile.upn&&(d("login_hint",e)||(e+="&login_hint="+encodeURIComponent(t.profile.upn)),!d("domain_hint",e)&&t.profile.upn.indexOf("@")>-1)){var n=t.profile.upn.split("@");e+="&domain_hint="+encodeURIComponent(n[n.length-1])}return e}function F(e){const t=function(e){let n=function(e){if(w(e))return;let n=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(n&&!(n.length<4))return{header:n[1],JWSPayload:n[2],JWSSig:n[3]};r.warn("The returned id_token is not parseable.")}(e);var t;if(n)try{let e=(t=(t=n.JWSPayload).replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(t))));return e?JSON.parse(e):void r.info("The returned id_token could not be base64 url safe decoded.")}catch(e){r.error("The returned id_token could not be decoded",e)}}(e);if(h(t,"aud"))return t.aud.toLowerCase()===n.clientId.toLowerCase()?{userName:t.upn||t.email,profile:t}:void r.warn("IdToken has invalid aud field")}let M=(e,t)=>n.instance+n.tenant+"/oauth2/authorize"+T(e,n,t);function Q(e){return document.getElementById(e)||(r.info("Add adal frame to document:"+e),document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}return window._adalInstance={config:n,login:function(){if(l)return void r.info("Login in progress");l=!0;const t=m(),i=window.location.href;n.state=t,o=m(),r.verbose("Expected state: "+t+" startPage:"+i),u(e.LOGIN_REQUEST,i),u(e.LOGIN_ERROR,""),u(e.STATE_LOGIN,t,!0),u(e.NONCE_IDTOKEN,o,!0),u(e.ERROR,""),u(e.ERROR_DESCRIPTION,"");const a=M("id_token")+"&nonce="+encodeURIComponent(o);n.displayCall?n.displayCall(a):n.popUp?(u(e.STATE_LOGIN,""),v.push(t),W(t,n.clientId,n.callback),y(a)):G(a)},logOut:function(){let o;if(function(){u(e.LOGIN_REQUEST,""),u(e.SESSION_STATE,""),u(e.STATE_LOGIN,""),u(e.STATE_RENEW,""),v=[],u(e.NONCE_IDTOKEN,""),u(e.IDTOKEN,""),u(e.ERROR,""),u(e.ERROR_DESCRIPTION,""),u(e.LOGIN_ERROR,""),u(e.LOGIN_ERROR,"");var n=g(e.TOKEN_KEYS);if(!w(n)){n=n.split("|");for(var t=0;t<n.length&&""!==n[t];t++)u(e.ACCESS_TOKEN_KEY+n[t],""),u(e.EXPIRATION_KEY+n[t],0)}u(e.TOKEN_KEYS,"")}(),t=null,n.logOutUri)o=n.logOutUri;else{let e="";n.postLogoutRedirectUri&&(e="post_logout_redirect_uri="+encodeURIComponent(n.postLogoutRedirectUri)),o=n.instance+n.tenant+"/oauth2/logout?"+e}r.infoPii("Logout navigate to: "+o),G(o)},getUser:A,getCachedUser:A,getCachedToken:L,registerCallback:W,acquireToken:function(e,o){if(!e){const e="resource is required";return r.warn(e),void o(e,null,e)}const s=L(e);if(s)return r.info("Token is already in cache for resource:"+e),void o(null,s,null);if(!(t||n.extraQueryParameter&&-1!==n.extraQueryParameter.indexOf("login_hint"))){const e="User login is required";return r.warn(e),void o(e,null,e)}c[e]?W(c[e],e,o):(P=i.RENEW_TOKEN,e===n.clientId?t?(r.verbose("renewing idtoken"),q(o)):(r.verbose("renewing idtoken and access_token"),q(o,a.ID_TOKEN)):t?(r.verbose("renewing access_token"),x(e,o)):(r.verbose("renewing idtoken and access_token"),x(e,o,a.ID_TOKEN)))},acquireTokenPopup:function(e,o,a,s){if(function(e){let o;return e?t?k&&(o="Acquire token interactive is already in progress"):o="User login is required":o="Resource is required",o&&(r.warn(o),n.callback(o,null,o)),!o}(e)){var c=m()+"|"+e;n.state=c,v.push(c),P=i.RENEW_TOKEN,r.verbose("Renew token Expected state: "+c);var l=p(M("token",e),"prompt");if(l+="&prompt=select_account",o&&(l+=o),a){if(-1!==l.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");l+="&claims="+encodeURIComponent(a)}l=Y(l),k=!0,r.info("acquireToken interactive is called for the resource "+e),W(c,e,s),y(l,e,s)}},getRequestInfo:function(n){const t={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:i.UNKNOWN},o=R(f(n));if(!o)return t;if(t.parameters=o,h(o,"error_description")||h(o,"access_token")||h(o,"id_token")){if(t.valid=!0,!o.hasOwnProperty("state"))return r.warn("No state returned"),t;if(r.verbose("State: "+o.state),t.stateResponse=o.state,function(n){const t=g(e.STATE_LOGIN);if(t)for(const e of t.split("||"))if(e===n.stateResponse)return n.requestType=i.LOGIN,n.stateMatch=!0,!0;const o=g(e.STATE_RENEW);if(o)for(const e of o.split("||"))if(e===n.stateResponse)return n.requestType=i.RENEW_TOKEN,n.stateMatch=!0,!0;return!1}(t))return t;if(!t.stateMatch&&window.parent){t.requestType=P;for(const e of v)if(e===t.stateResponse){t.stateMatch=!0;break}}}return t},saveTokenFromHash:function(o){r.info("State status:"+o.stateMatch+"; Request type:"+o.requestType),u(e.ERROR,""),u(e.ERROR_DESCRIPTION,"");let a=O(o.stateResponse);if(o.parameters.hasOwnProperty("error_description"))r.infoPii("Error :"+o.parameters.error+"; Error description:"+o.parameters.error_description),u(e.ERROR,o.parameters.error),u(e.ERROR_DESCRIPTION,o.parameters.error_description),o.requestType===i.LOGIN&&(l=!1,u(e.LOGIN_ERROR,o.parameters.error_description));else if(o.stateMatch){let i;if(r.info("State is right"),o.parameters.hasOwnProperty("session_state")&&u(e.SESSION_STATE,o.parameters.session_state),o.parameters.hasOwnProperty("access_token")&&(r.info("Fragment has access token"),E(a)||(i=g(e.TOKEN_KEYS)||"",u(e.TOKEN_KEYS,i+a+"|")),u(e.ACCESS_TOKEN_KEY+a,o.parameters.access_token),u(e.EXPIRATION_KEY+a,N(o.parameters.expires_in))),o.parameters.hasOwnProperty("id_token"))if(l=!1,t=F(o.parameters.id_token),t&&t.profile)I(t)?(u(e.IDTOKEN,o.parameters.id_token),a=n.loginResource?n.loginResource:n.clientId,E(a)||(i=g(e.TOKEN_KEYS)||"",u(e.TOKEN_KEYS,i+a+"|")),u(e.ACCESS_TOKEN_KEY+a,o.parameters.id_token),u(e.EXPIRATION_KEY+a,t.profile.exp)):(u(e.LOGIN_ERROR,"Nonce received: "+t.profile.nonce+" is not same as requested: "+g(e.NONCE_IDTOKEN)),t=null);else{const n="invalid id_token",t="Invalid id_token. id_token: "+o.parameters.id_token;o.parameters.error=n,o.parameters.error_description=t,u(e.ERROR,n),u(e.ERROR_DESCRIPTION,t)}}else{const n="Invalid_state",t="Invalid_state. state: "+o.stateResponse;o.parameters.error=n,o.parameters.error_description=t,u(e.ERROR,n),u(e.ERROR_DESCRIPTION,t)}u(e.RENEW_STATUS+a,s.Completed)},loginInProgress:()=>l,_callBackMappedToRenewStates:K,_callBacksMappedToRenewStates:b}}!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(i||(i={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(a||(a={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(s||(s={}));let l=n=>{u(e.STATE_RENEW,""),u(e.ERROR,""),u(e.ERROR_DESCRIPTION,""),E(n)&&(u(e.ACCESS_TOKEN_KEY+n,""),u(e.EXPIRATION_KEY+n,0))},d=(e,n)=>new RegExp("[\\?&]"+e+"=").test(n),p=(e,n)=>e.replace(new RegExp("(\\&"+n+"=)[^&]+"),"").replace(new RegExp("("+n+"=)[^&]+&"),"").replace(new RegExp("("+n+"=)[^&]+"),""),u=(e,t,o=!1)=>{if(o){let o=g(e)||"";n.setItem(e,o+t+"||")}else n.setItem(e,t)},E=n=>{const t=g(e.TOKEN_KEYS);return!w(t)&&t.indexOf(n+"|")>-1},f=e=>e.indexOf("#/")>-1?e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1?e.substring(1):e,_=e=>{const n=R(f(e));return h(n,"error_description")||h(n,"access_token")||h(n,"id_token")},R=e=>{let n=/\+/g,t=/([^&=]+)=([^&]*)/g,o=e=>decodeURIComponent(e.replace(n," ")),r={},i=t.exec(e);for(;i;)r[o(i[1])]=o(i[2]),i=t.exec(e);return r},I=n=>{const t=g(e.NONCE_IDTOKEN);if(t)for(const e of t.split("||"))if(e===n.profile.nonce)return!0;return!1},O=e=>{if(e){let n=e.indexOf("|");if(n>-1&&n+1<e.length)return e.substring(n+1)}return""},N=e=>(e||(e=3599),S()+parseInt(e,10)),T=(e,n,t)=>{if(!n)return"";const o=["?response_type="+e,"client_id="+encodeURIComponent(n.clientId)];t&&o.push("resource="+encodeURIComponent(t)),o.push("redirect_uri="+encodeURIComponent(n.redirectUri)),o.push("state="+encodeURIComponent(n.state)),h(n,"slice")&&o.push("slice="+encodeURIComponent(n.slice)),h(n,"extraQueryParameter")&&o.push(n.extraQueryParameter);const r=n.correlationId||m();return o.push("client-request-id="+encodeURIComponent(r)),o.join("&")},m=()=>{let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let n=e.toString(16);for(;n.length<2;)n="0"+n;return n}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]},g=e=>n.getItem(e),w=e=>!e||!e.length,h=(e,n)=>Object.hasOwnProperty.call(e,n),S=()=>Math.round(Date.now()/1e3);export{c as AuthenticationContext,l as clearCacheForResource};
//# sourceMappingURL=adal.modern.js.map
