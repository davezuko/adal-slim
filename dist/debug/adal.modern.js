var e;!function(e){e.TOKEN_KEYS="adal.token.keys",e.ACCESS_TOKEN_KEY="adal.access.token.key",e.EXPIRATION_KEY="adal.expiration.key",e.STATE_LOGIN="adal.state.login",e.STATE_RENEW="adal.state.renew",e.NONCE_IDTOKEN="adal.nonce.idtoken",e.SESSION_STATE="adal.session.state",e.USERNAME="adal.username",e.IDTOKEN="adal.idtoken",e.ERROR="adal.error",e.ERROR_DESCRIPTION="adal.error.description",e.LOGIN_REQUEST="adal.login.request",e.LOGIN_ERROR="adal.login.error",e.RENEW_STATUS="adal.token.renew.status"}(e||(e={}));const n=(()=>{function e(e){const n=window[e];return!!n&&(n.setItem("__test__","__test__"),"__test__"===n.getItem("__test__")&&(n.removeItem("__test__"),!n.getItem("__test__")))}return e("localStorage")?localStorage:e("sessionStorage")?sessionStorage:{getItem(){},setItem(){}}})();var t;!function(e){e[e.Error=0]="Error",e[e.Warn=1]="Warn",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose"}(t||(t={}));const o={[t.Error]:"ERROR",[t.Warn]:"WARNING",[t.Info]:"INFO",[t.Verbose]:"VERBOSE"},r={pii:!1,correlationId:void 0,level:t.Error,log(e,n,t,r=!1){if((!r||this.pii)&&e<=this.level){let r=(new Date).toUTCString()+":"+(this.correlationId?this.correlationId+"-":"")+o[e]+": "+n;t&&(r+="\nstack:\n"+t.stack),console.log(r)}},error(e,n){this.log(t.Error,e,n)},warn(e){this.log(t.Warn,e,null)},info(e){this.log(t.Info,e,null)},verbose(e){this.log(t.Verbose,e,null)},errorPii(e,n){this.log(t.Error,e,n,!0)},warnPii(e){this.log(t.Warn,e,null,!0)},infoPii(e){this.log(t.Info,e,null,!0)},verbosePii(e){this.log(t.Verbose,e,null,!0)}};var i,a,s;function l(n){if(window._adalInstance)return window._adalInstance;let t,o;n=(e=>(e={popUp:!1,instance:"https://login.microsoftonline.com/",loginResource:e.clientId,laodFrameTimeout:6e3,expireOffsetSeconds:300,anonymousEndpoints:[],navigateToLoginRequestUrl:!0,tenant:"common",redirectUri:window.location.href.split("?")[0].split("#")[0],callback:()=>{},...e},r.correlationId=e.correlationId,e))(n);let l={},c=!1,v=!1,C=[],K=[],b={},U={},P=i.LOGIN;function y(n,t,o,i,a){r.warn(i),E(e.ERROR,o),E(e.ERROR_DESCRIPTION,i),E(e.LOGIN_ERROR,a),t&&l[t]&&(l[t]=null),c=!1,v=!1,n&&n(i,null,o)}function A(e,t,o){var i=function(e,n,t,o){try{const n=window.innerWidth/2-241.5+window.screenX,t=window.innerHeight/2-300+window.screenY,o=window.open(e,"login","width=483, height=600, top="+t+", left="+n);return o.focus&&o.focus(),o}catch(e){r.warn("Error opening popup, "+e.message),c=!1,v=!1}}(e),a=o||n.callback;if(!i){var s="Popup Window is null. This can happen if you are using IE";return void y(a,t,"Error opening popup",s,s)}K.push(i);const l=n.redirectUri.split("#")[0];let d=setInterval(()=>{if(!i||i.closed||void 0===i.closed){let e="Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge";return y(a,t,"Popup Window closed",e,e),void clearInterval(d)}try{let e=i.location;if(-1!=encodeURI(e.href).indexOf(encodeURI(l)))return M(e.hash),clearInterval(d),c=!1,v=!1,r.info("Closing popup window"),K=[],void i.close()}catch(e){}},1)}function W(){if(!t){const n=w(e.IDTOKEN);n&&(t=F(n))}return t}function L(e,n,t){l[n]=e,U[e]||(U[e]=[]),U[e].push(t),b[e]||(b[e]=(t,o,i,a)=>{l[n]=null;for(var s=0;s<U[e].length;++s)try{U[e][s](t,o,i,a)}catch(i){r.warn(i)}U[e]=null,b[e]=null})}function x(t,i,s="token"){r.info("renewToken is called for resource:"+t);let l=X("adalRenewFrame"+t),c=g()+"|"+t;n.state=c,C.push(c),r.verbose("Renew token Expected state: "+c);let d=u(Q(s,t),"prompt");s===a.ID_TOKEN&&(o=g(),E(e.NONCE_IDTOKEN,o,!0),d+="&nonce="+encodeURIComponent(o)),d+="&prompt=none",d=Y(d),L(c,t,i),r.verbosePii("Navigate to:"+d),l.src="about:blank",D(d,"adalRenewFrame"+t,t)}function q(t,i){let a=X("adalIdTokenFrame"),s=g()+"|"+n.clientId;o=g(),E(e.NONCE_IDTOKEN,o,!0),n.state=s,C.push(s),r.verbose("Renew Idtoken Expected state: "+s);let l=i||n.clientId,c=u(Q(i=i||"id_token",l),"prompt");c=Y(c+"&prompt=none"),c+="&nonce="+encodeURIComponent(o),L(s,n.clientId,t),r.verbosePii("Navigate to:"+c),a.src="about:blank",D(c,"adalIdTokenFrame",n.clientId)}function D(t,o,i){r.verbose("Set loading state to pending for: "+i),E(e.RENEW_STATUS+i,s.InProgress),function e(n,t){r.info("LoadFrame: "+t),setTimeout(()=>{const o=X(t);o.src&&"about:blank"!==o.src||(o.src=n,e(n,t))},500)}(t,o),setTimeout(()=>{if(w(e.RENEW_STATUS+i)===s.InProgress){r.verbose("Loading frame has timed out after: "+n.loadFrameTimeout/1e3+" seconds for resource "+i);var t=l[i];t&&b[t]&&b[t]("Token renewal operation failed due to timeout",null,"Token Renewal Failed"),E(e.RENEW_STATUS+i,s.Canceled)}},n.loadFrameTimeout)}function G(e){e?(r.infoPii("Navigate to:"+e),window.location.replace(e)):r.info("Navigate url is empty")}function Y(e){if(!t||!t.profile)return e;if(t.profile.sid&&-1!==e.indexOf("&prompt=none"))p("sid",e)||(e+="&sid="+encodeURIComponent(t.profile.sid));else if(t.profile.upn&&(p("login_hint",e)||(e+="&login_hint="+encodeURIComponent(t.profile.upn)),!p("domain_hint",e)&&t.profile.upn.indexOf("@")>-1)){var n=t.profile.upn.split("@");e+="&domain_hint="+encodeURIComponent(n[n.length-1])}return e}function F(e){const t=function(e){let n=d(e);var t;if(n)try{let e=(t=(t=n.JWSPayload).replace(/-/g,"+").replace(/_/g,"/"),decodeURIComponent(escape(window.atob(t))));return e?JSON.parse(e):void r.info("The returned id_token could not be base64 url safe decoded.")}catch(e){r.error("The returned id_token could not be decoded",e)}}(e);if(S(t,"aud"))return t.aud.toLowerCase()===n.clientId.toLowerCase()?{userName:t.upn||t.email,profile:t}:void r.warn("IdToken has invalid aud field")}function M(n=window.location.hash){if(!R(n))return;let t,o;const a=K[K.length-1];a&&a.opener&&a.opener._adalInstance?(t=a.opener._adalInstance,o=!0):window.parent&&window.parent._adalInstance&&(t=window.parent._adalInstance);let s,l,c,d=t.getRequestInfo(n);s=o||window.parent!==window?t._callBackMappedToRenewStates[d.stateResponse]:t.config.callback,t.saveTokenFromHash(d),d.requestType===i.RENEW_TOKEN&&window.parent?(window.parent!==window?r.verbose("Window is in iframe, acquiring token silently"):r.verbose("acquiring token interactive in progress"),l=d.parameters.access_token||d.parameters.id_token,c="access_token"):d.requestType===i.LOGIN&&(l=d.parameters.id_token,c="id_token");let p=d.parameters.error_description,u=d.parameters.error;try{s&&s(p,l,u,c)}catch(e){r.error("Error occurred in user defined callback function: "+e)}window.parent!==window||o||(t.config.navigateToLoginRequestUrl?window.location.href=w(e.LOGIN_REQUEST):window.location.hash="")}let Q=(e,t)=>n.instance+n.tenant+"/oauth2/authorize"+m(e,n,t);function X(e){return document.getElementById(e)||(r.info("Add adal frame to document:"+e),document.body.insertAdjacentHTML("beforeEnd",`<iframe name="${e}" id="${e}" style="display:none"></iframe>`),window.frames&&window.frames[e])}return window._adalInstance={config:n,login:function(){if(c)return void r.info("Login in progress");c=!0;const t=g(),i=window.location.href;n.state=t,o=g(),r.verbose("Expected state: "+t+" startPage:"+i),E(e.LOGIN_REQUEST,i),E(e.LOGIN_ERROR,""),E(e.STATE_LOGIN,t,!0),E(e.NONCE_IDTOKEN,o,!0),E(e.ERROR,""),E(e.ERROR_DESCRIPTION,"");const a=Q("id_token")+"&nonce="+encodeURIComponent(o);n.displayCall?n.displayCall(a):n.popUp?(E(e.STATE_LOGIN,""),C.push(t),L(t,n.clientId,n.callback),A(a)):G(a)},logout:function(){let o;if(function(){E(e.LOGIN_REQUEST,""),E(e.SESSION_STATE,""),E(e.STATE_LOGIN,""),E(e.STATE_RENEW,""),C=[],E(e.NONCE_IDTOKEN,""),E(e.IDTOKEN,""),E(e.ERROR,""),E(e.ERROR_DESCRIPTION,""),E(e.LOGIN_ERROR,""),E(e.LOGIN_ERROR,"");var n=w(e.TOKEN_KEYS);if(!h(n)){n=n.split("|");for(var t=0;t<n.length&&""!==n[t];t++)E(e.ACCESS_TOKEN_KEY+n[t],""),E(e.EXPIRATION_KEY+n[t],0)}E(e.TOKEN_KEYS,"")}(),t=null,n.logOutUri)o=n.logOutUri;else{let e="";n.postLogoutRedirectUri&&(e="post_logout_redirect_uri="+encodeURIComponent(n.postLogoutRedirectUri)),o=n.instance+n.tenant+"/oauth2/logout?"+e}r.infoPii("Logout navigate to: "+o),G(o)},getUser:W,getCachedUser:W,registerCallback:L,acquireToken:function(o,s){if(!o){const e="resource is required";return r.warn(e),void s(e,null,e)}const c=function(t){if(!_(t))return;const o=w(e.ACCESS_TOKEN_KEY+t),r=w(e.EXPIRATION_KEY+t);if(r&&r>k()+n.expireOffsetSeconds)return o;E(e.ACCESS_TOKEN_KEY+t,""),E(e.EXPIRATION_KEY+t,0)}(o);if(c)return r.info("Token is already in cache for resource:"+o),void s(null,c,null);if(!(t||n.extraQueryParameter&&-1!==n.extraQueryParameter.indexOf("login_hint"))){const e="User login is required";return r.warn(e),void s(e,null,e)}l[o]?L(l[o],o,s):(P=i.RENEW_TOKEN,o===n.clientId?t?(r.verbose("renewing idtoken"),q(s)):(r.verbose("renewing idtoken and access_token"),q(s,a.ID_TOKEN)):t?(r.verbose("renewing access_token"),x(o,s)):(r.verbose("renewing idtoken and access_token"),x(o,s,a.ID_TOKEN)))},acquireTokenPopup:function(e,o,a,s){if(function(e){let o;return e?t?v&&(o="Acquire token interactive is already in progress"):o="User login is required":o="Resource is required",o&&(r.warn(o),n.callback(o,null,o)),!o}(e)){var l=g()+"|"+e;n.state=l,C.push(l),P=i.RENEW_TOKEN,r.verbose("Renew token Expected state: "+l);var c=u(Q("token",e),"prompt");if(c+="&prompt=select_account",o&&(c+=o),a){if(-1!==c.indexOf("&claims"))throw new Error("Claims cannot be passed as an extraQueryParameter");c+="&claims="+encodeURIComponent(a)}c=Y(c),v=!0,r.info("acquireToken interactive is called for the resource "+e),L(l,e,s),A(c,e,s)}},getRequestInfo:function(n){const t={valid:!1,parameters:{},stateMatch:!1,stateResponse:"",requestType:i.UNKNOWN},o=I(f(n));if(!o)return t;if(t.parameters=o,S(o,"error_description")||S(o,"access_token")||S(o,"id_token")){if(t.valid=!0,!S(o,"state"))return r.warn("No state returned"),t;if(r.verbose("State: "+o.state),t.stateResponse=o.state,function(n){const t=w(e.STATE_LOGIN);if(t)for(const e of t.split("||"))if(e===n.stateResponse)return n.requestType=i.LOGIN,n.stateMatch=!0,!0;const o=w(e.STATE_RENEW);if(o)for(const e of o.split("||"))if(e===n.stateResponse)return n.requestType=i.RENEW_TOKEN,n.stateMatch=!0,!0;return!1}(t))return t;if(!t.stateMatch&&window.parent){t.requestType=P;for(const e of C)if(e===t.stateResponse){t.stateMatch=!0;break}}}return t},saveTokenFromHash:function(o){r.info("State status:"+o.stateMatch+"; Request type:"+o.requestType),E(e.ERROR,""),E(e.ERROR_DESCRIPTION,"");let a=N(o.stateResponse);if(o.parameters.hasOwnProperty("error_description"))r.infoPii("Error :"+o.parameters.error+"; Error description:"+o.parameters.error_description),E(e.ERROR,o.parameters.error),E(e.ERROR_DESCRIPTION,o.parameters.error_description),o.requestType===i.LOGIN&&(c=!1,E(e.LOGIN_ERROR,o.parameters.error_description));else if(o.stateMatch){let i;if(r.info("State is right"),o.parameters.hasOwnProperty("session_state")&&E(e.SESSION_STATE,o.parameters.session_state),o.parameters.hasOwnProperty("access_token")&&(r.info("Fragment has access token"),_(a)||(i=w(e.TOKEN_KEYS)||"",E(e.TOKEN_KEYS,i+a+"|")),E(e.ACCESS_TOKEN_KEY+a,o.parameters.access_token),E(e.EXPIRATION_KEY+a,T(o.parameters.expires_in))),o.parameters.hasOwnProperty("id_token"))if(c=!1,t=F(o.parameters.id_token),t&&t.profile)O(t)?(E(e.IDTOKEN,o.parameters.id_token),a=n.loginResource?n.loginResource:n.clientId,_(a)||(i=w(e.TOKEN_KEYS)||"",E(e.TOKEN_KEYS,i+a+"|")),E(e.ACCESS_TOKEN_KEY+a,o.parameters.id_token),E(e.EXPIRATION_KEY+a,t.profile.exp)):(E(e.LOGIN_ERROR,"Nonce received: "+t.profile.nonce+" is not same as requested: "+w(e.NONCE_IDTOKEN)),t=null);else{const n="invalid id_token",t="Invalid id_token. id_token: "+o.parameters.id_token;o.parameters.error=n,o.parameters.error_description=t,E(e.ERROR,n),E(e.ERROR_DESCRIPTION,t)}}else{const n="Invalid_state",t="Invalid_state. state: "+o.stateResponse;o.parameters.error=n,o.parameters.error_description=t,E(e.ERROR,n),E(e.ERROR_DESCRIPTION,t)}E(e.RENEW_STATUS+a,s.Completed)},loginInProgress:()=>c,handleWindowCallback:M,_callBackMappedToRenewStates:b,_callBacksMappedToRenewStates:U}}!function(e){e.LOGIN="LOGIN",e.RENEW_TOKEN="RENEW_TOKEN",e.UNKNOWN="UNKNOWN"}(i||(i={})),function(e){e.ID_TOKEN="id_token token",e.TOKEN="token"}(a||(a={})),function(e){e.Canceled="Canceled",e.Completed="Completed",e.InProgress="In Progress"}(s||(s={}));let c=n=>{E(e.STATE_RENEW,""),E(e.ERROR,""),E(e.ERROR_DESCRIPTION,""),_(n)&&(E(e.ACCESS_TOKEN_KEY+n,""),E(e.EXPIRATION_KEY+n,0))},d=e=>{if(h(e))return;let n=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(n&&!(n.length<4))return{header:n[1],JWSPayload:n[2],JWSSig:n[3]};r.warn("The returned id_token is not parseable.")},p=(e,n)=>new RegExp("[\\?&]"+e+"=").test(n),u=(e,n)=>e.replace(new RegExp("(\\&"+n+"=)[^&]+"),"").replace(new RegExp("("+n+"=)[^&]+&"),"").replace(new RegExp("("+n+"=)[^&]+"),""),E=(e,t,o=!1)=>{if(o){let o=w(e)||"";n.setItem(e,o+t+"||")}else n.setItem(e,t)},_=n=>{const t=w(e.TOKEN_KEYS);return!h(t)&&t.indexOf(n+"|")>-1},f=e=>e.indexOf("#/")>-1?e.substring(e.indexOf("#/")+2):e.indexOf("#")>-1?e.substring(1):e,R=e=>{const n=I(f(e));return S(n,"error_description")||S(n,"access_token")||S(n,"id_token")},I=e=>{let n=/\+/g,t=/([^&=]+)=([^&]*)/g,o=e=>decodeURIComponent(e.replace(n," ")),r={},i=t.exec(e);for(;i;)r[o(i[1])]=o(i[2]),i=t.exec(e);return r},O=n=>{const t=w(e.NONCE_IDTOKEN);if(t)for(const e of t.split("||"))if(e===n.profile.nonce)return!0;return!1},N=e=>{if(e){let n=e.indexOf("|");if(n>-1&&n+1<e.length)return e.substring(n+1)}return""},T=e=>(e||(e=3599),k()+parseInt(e,10)),m=(e,n,t)=>{if(!n)return"";const o=["?response_type="+e,"client_id="+encodeURIComponent(n.clientId)];t&&o.push("resource="+encodeURIComponent(t)),o.push("redirect_uri="+encodeURIComponent(n.redirectUri)),o.push("state="+encodeURIComponent(n.state)),S(n,"slice")&&o.push("slice="+encodeURIComponent(n.slice)),S(n,"extraQueryParameter")&&o.push(n.extraQueryParameter);const r=n.correlationId||g();return o.push("client-request-id="+encodeURIComponent(r)),o.join("&")},g=()=>{let e=new Uint8Array(16);return crypto.getRandomValues(e),e[6]|=64,e[6]&=79,e[8]|=128,e[8]&=191,e=e.map(e=>{let n=e.toString(16);for(;n.length<2;)n="0"+n;return n}),e[0]+e[1]+e[2]+e[3]+"-"+e[4]+e[5]+"-"+e[6]+e[7]+"-"+e[8]+e[9]+"-"+e[10]+e[11]+e[12]+e[13]+e[14]+e[15]},w=e=>n.getItem(e),h=e=>!e||!e.length,S=(e,n)=>Object.hasOwnProperty.call(e,n),k=()=>Math.round(Date.now()/1e3);export{l as AuthenticationContext,c as clearCacheForResource};
//# sourceMappingURL=adal.modern.js.map
