{"version":3,"file":"adal.modern.js","sources":["../lib/storage.ts","../lib/logger.ts","../lib/adal.ts"],"sourcesContent":["export enum StorageKey {\n    TOKEN_KEYS = \"adal.token.keys\",\n    ACCESS_TOKEN_KEY = \"adal.access.token.key\",\n    EXPIRATION_KEY = \"adal.expiration.key\",\n    STATE_LOGIN = \"adal.state.login\",\n    STATE_RENEW = \"adal.state.renew\",\n    NONCE_IDTOKEN = \"adal.nonce.idtoken\",\n    SESSION_STATE = \"adal.session.state\",\n    USERNAME = \"adal.username\",\n    IDTOKEN = \"adal.idtoken\",\n    ERROR = \"adal.error\",\n    ERROR_DESCRIPTION = \"adal.error.description\",\n    LOGIN_REQUEST = \"adal.login.request\",\n    LOGIN_ERROR = \"adal.login.error\",\n    RENEW_STATUS = \"adal.token.renew.status\",\n}\n\ninterface IStorage {\n    getItem(key: string): any\n    setItem(key: string, value: any, preserve?: boolean): void\n}\n\nexport const Storage: IStorage = (() => {\n    function supportsStorage(type: string) {\n        const storage = window[type]\n        if (!storage) {\n            return false\n        }\n        const testKey = \"__test__\"\n        storage.setItem(testKey, testKey)\n        if (storage.getItem(testKey) !== testKey) {\n            return false\n        }\n        storage.removeItem(testKey)\n        if (storage.getItem(testKey)) {\n            return false\n        }\n        return true\n    }\n\n    if (supportsStorage(\"localStorage\")) return localStorage\n    if (supportsStorage(\"sessionStorage\")) return sessionStorage\n    return {getItem() {}, setItem() {}} as IStorage\n})()\n","import {VERSION} from \"./version\"\n\nexport enum LogLevel {\n    Error = 0,\n    Warn,\n    Info,\n    Verbose,\n}\n\nconst LOG_LEVEL_LABELS = {\n    [LogLevel.Error]: \"ERROR\",\n    [LogLevel.Warn]: \"WARNING\",\n    [LogLevel.Info]: \"INFO\",\n    [LogLevel.Verbose]: \"VERBOSE\",\n}\n\nexport class Logger {\n    pii = false\n    correlationId: string | undefined\n    level = LogLevel.Error\n\n    /**\n     * Checks the Logging Level, constructs the Log message and logs it. Users need to implement/override this method to turn on Logging.\n     * @param {number} level  -  Level can be set 0,1,2 and 3 which turns on 'error', 'warning', 'info' or 'verbose' level logging respectively.\n     * @param {string} message  -  Message to log.\n     * @param {string} error  -  Error to log.\n     */\n    log(\n        level: LogLevel,\n        message: string,\n        error: Error | string | undefined | null,\n        containsPii = false,\n    ) {\n        if (containsPii && !this.pii) return\n\n        if (level <= this.level) {\n            let timestamp = new Date().toUTCString()\n            let formattedMessage =\n                timestamp +\n                \":\" +\n                (this.correlationId ? this.correlationId + \"-\" : \"\") +\n                VERSION +\n                \"-\" +\n                LOG_LEVEL_LABELS[level] +\n                \": \" +\n                message\n\n            if (error) {\n                // @ts-expect-error\n                formattedMessage += \"\\nstack:\\n\" + error.stack\n            }\n\n            console.log(formattedMessage)\n        }\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 0.\n     * @param {string} message  -  Message to log.\n     * @param {string} error  -  Error to log.\n     */\n    error(message: string, error?: Error) {\n        this.log(LogLevel.Error, message, error)\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 1.\n     * @param {string} message  -  Message to log.\n     */\n    warn(message: string) {\n        this.log(LogLevel.Warn, message, null)\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 2.\n     * @param {string} message  -  Message to log.\n     */\n    info(message: string) {\n        this.log(LogLevel.Info, message, null)\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 3.\n     * @param {string} message  -  Message to log.\n     */\n    verbose(message: string) {\n        this.log(LogLevel.Verbose, message, null)\n    }\n\n    /**\n     * Logs Pii messages when Logging Level is set to 0 and window.piiLoggingEnabled is set to true.\n     * @param {string} message  -  Message to log.\n     * @param {string} error  -  Error to log.\n     */\n    errorPii(message: string, error: string) {\n        this.log(LogLevel.Error, message, error, true)\n    }\n\n    /**\n     * Logs  Pii messages when Logging Level is set to 1 and window.piiLoggingEnabled is set to true.\n     * @param {string} message  -  Message to log.\n     */\n    warnPii(message: string) {\n        this.log(LogLevel.Warn, message, null, true)\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 2 and window.piiLoggingEnabled is set to true.\n     * @param {string} message  -  Message to log.\n     */\n    infoPii(message: string) {\n        this.log(LogLevel.Info, message, null, true)\n    }\n\n    /**\n     * Logs messages when Logging Level is set to 3 and window.piiLoggingEnabled is set to true.\n     * @param {string} message  -  Message to log.\n     */\n    verbosePii(message: string) {\n        this.log(LogLevel.Verbose, message, null, true)\n    }\n}\n","// AdalJS v1.0.17\n//----------------------------------------------------------------------\n// @preserve Copyright (c) Microsoft Open Technologies, Inc.\n// All Rights Reserved\n// Apache License 2.0\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n// http://www.apache.org/licenses/LICENSE-2.0\n//id\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n//----------------------------------------------------------------------\nimport {Storage, StorageKey} from \"./storage\"\nimport {Logger} from \"./logger\"\nimport {VERSION} from \"./version\"\n\nenum RequestType {\n    LOGIN = \"LOGIN\",\n    RENEW_TOKEN = \"RENEW_TOKEN\",\n    UNKNOWN = \"UNKNOWN\",\n}\nenum ResponseType {\n    ID_TOKEN = \"id_token token\",\n    TOKEN = \"token\",\n}\n\nenum TokenRenewStatus {\n    Canceled = \"Canceled\",\n    Completed = \"Completed\",\n    InProgress = \"In Progress\",\n}\n\nconst ACCESS_TOKEN = \"access_token\",\n    EXPIRES_IN = \"expires_in\",\n    ID_TOKEN = \"id_token\",\n    ERROR = \"error\",\n    ERROR_DESCRIPTION = \"error_description\",\n    SESSION_STATE = \"session_state\",\n    RESOURCE_DELIMETER = \"|\",\n    CACHE_DELIMETER = \"||\"\n\ntype Config = any\ntype Options = any\nexport class Adal {\n    config: Config\n    logger = new Logger()\n\n    // TODO: move off of instance for smaller property names\n    _user: any\n    _idTokenNonce: any\n    _activeRenewals: any = {}\n    _loginInProgress = false\n    _acquireTokenInProgress = false\n    _renewStates: any[] = []\n    _openedWindows: any[] = []\n    _callBackMappedToRenewStates: any = {}\n    _callBacksMappedToRenewStates: any = {}\n    _requestType = RequestType.LOGIN\n\n    constructor(options: Options) {\n        if ((window as any)._adalInstance) {\n            return (window as any)._adalInstance\n        }\n        this.config = {\n            popUp: false,\n            instance: \"https://login.microsoftonline.com/\",\n            loginResource: options.clientId,\n            laodFrameTimeout: 6000,\n            expireOffsetSeconds: 300,\n            anonymousEndpoints: [],\n            navigateToLoginRequestUrl: true,\n            tenant: \"common\",\n            redirectUri: window.location.href.split(\"?\")[0].split(\"#\")[0],\n            callback: () => {},\n            ...options,\n        }\n        this.logger.correlationId = options.correlationId\n        ;(window as any)._adalInstance = this\n    }\n\n    /**\n     * Initiates the login process by redirecting the user to Azure AD authorization endpoint.\n     */\n    login() {\n        if (this._loginInProgress) {\n            this.logger.info(\"Login in progress\")\n            return\n        }\n\n        this._loginInProgress = true\n\n        // Token is not present and user needs to login\n        const expectedState = guid()\n        const loginStartPage = window.location.href\n        this.config.state = expectedState\n        this._idTokenNonce = guid()\n\n        this.logger.verbose(\n            \"Expected state: \" + expectedState + \" startPage:\" + loginStartPage,\n        )\n        saveItem(StorageKey.LOGIN_REQUEST, loginStartPage)\n        saveItem(StorageKey.LOGIN_ERROR, \"\")\n        saveItem(StorageKey.STATE_LOGIN, expectedState, true)\n        saveItem(StorageKey.NONCE_IDTOKEN, this._idTokenNonce, true)\n        saveItem(StorageKey.ERROR, \"\")\n        saveItem(StorageKey.ERROR_DESCRIPTION, \"\")\n        var urlNavigate =\n            this._getNavigateUrl(\"id_token\") +\n            \"&nonce=\" +\n            encodeURIComponent(this._idTokenNonce)\n\n        if (this.config.displayCall) {\n            // User defined way of handling the navigation\n            this.config.displayCall(urlNavigate)\n        } else if (this.config.popUp) {\n            saveItem(StorageKey.STATE_LOGIN, \"\") // so requestInfo does not match redirect case\n            this._renewStates.push(expectedState)\n            this.registerCallback(\n                expectedState,\n                this.config.clientId,\n                this.config.callback,\n            )\n            this._loginPopup(urlNavigate)\n        } else {\n            this.promptUser(urlNavigate)\n        }\n    }\n\n    /**\n     * Configures popup window for login.\n     * @ignore\n     */\n    _openPopup(\n        urlNavigate: string,\n        title: string,\n        popUpWidth: number,\n        popUpHeight: number,\n    ) {\n        try {\n            const left = window.innerWidth / 2 - popUpWidth / 2 + window.screenX\n            const top =\n                window.innerHeight / 2 - popUpHeight / 2 + window.screenY\n            const popupWindow = window.open(\n                urlNavigate,\n                title,\n                \"width=\" +\n                    popUpWidth +\n                    \", height=\" +\n                    popUpHeight +\n                    \", top=\" +\n                    top +\n                    \", left=\" +\n                    left,\n            )!\n\n            if (popupWindow.focus) {\n                popupWindow.focus()\n            }\n\n            return popupWindow\n        } catch (e) {\n            this.logger.warn(\"Error opening popup, \" + e.message)\n            this._loginInProgress = false\n            this._acquireTokenInProgress = false\n            return null\n        }\n    }\n\n    _handlePopupError(\n        loginCallback: any,\n        resource: string | undefined | null,\n        error: string,\n        errorDesc: string,\n        loginError: string,\n    ) {\n        this.logger.warn(errorDesc)\n        saveItem(StorageKey.ERROR, error)\n        saveItem(StorageKey.ERROR_DESCRIPTION, errorDesc)\n        saveItem(StorageKey.LOGIN_ERROR, loginError)\n\n        if (resource && this._activeRenewals[resource]) {\n            this._activeRenewals[resource] = null\n        }\n\n        this._loginInProgress = false\n        this._acquireTokenInProgress = false\n\n        if (loginCallback) {\n            loginCallback(errorDesc, null, error)\n        }\n    }\n\n    /**\n     * After authorization, the user will be sent to your specified redirect_uri with the user's bearer token\n     * attached to the URI fragment as an id_token field. It closes popup window after redirection.\n     * @ignore\n     */\n    _loginPopup(urlNavigate: string, resource?: string, callback?: any) {\n        var popupWindow = this._openPopup(urlNavigate, \"login\", 483, 600)\n        var loginCallback = callback || this.config.callback\n\n        if (!popupWindow) {\n            var error = \"Error opening popup\"\n            var errorDesc =\n                \"Popup Window is null. This can happen if you are using IE\"\n            this._handlePopupError(\n                loginCallback,\n                resource,\n                error,\n                errorDesc,\n                errorDesc,\n            )\n            return\n        }\n\n        this._openedWindows.push(popupWindow)\n        const registeredRedirectUri = this.config.redirectUri.split(\"#\")[0]\n\n        var pollTimer = setInterval(() => {\n            if (\n                !popupWindow ||\n                popupWindow.closed ||\n                popupWindow.closed === undefined\n            ) {\n                var error = \"Popup Window closed\"\n                var errorDesc =\n                    \"Popup Window closed by UI action/ Popup Window handle destroyed due to cross zone navigation in IE/Edge\"\n\n                this._handlePopupError(\n                    loginCallback,\n                    resource,\n                    error,\n                    errorDesc,\n                    errorDesc,\n                )\n                clearInterval(pollTimer)\n                return\n            }\n            try {\n                var popUpWindowLocation = popupWindow.location\n                if (\n                    encodeURI(popUpWindowLocation.href).indexOf(\n                        encodeURI(registeredRedirectUri),\n                    ) != -1\n                ) {\n                    this.handleWindowCallback(popUpWindowLocation.hash)\n                    clearInterval(pollTimer)\n                    this._loginInProgress = false\n                    this._acquireTokenInProgress = false\n                    this.logger.info(\"Closing popup window\")\n                    this._openedWindows = []\n                    popupWindow.close()\n                    return\n                }\n            } catch (e) {}\n        }, 1)\n    }\n\n    loginInProgress() {\n        return this._loginInProgress\n    }\n\n    /**\n     * Checks for the resource in the cache. By default, cache location is Session Storage\n     * @ignore\n     * @returns {Boolean} 'true' if login is in progress, else returns 'false'.\n     */\n    _hasResource(key) {\n        var keys = getItem(StorageKey.TOKEN_KEYS)\n        return !isEmpty(keys) && keys.indexOf(key + RESOURCE_DELIMETER) > -1\n    }\n\n    /**\n     * Gets token for the specified resource from the cache.\n     * @param {string}   resource A URI that identifies the resource for which the token is requested.\n     * @returns {string} token if if it exists and not expired, otherwise null.\n     */\n    getCachedToken(resource: string) {\n        if (!this._hasResource(resource)) {\n            return null\n        }\n\n        const token = getItem(StorageKey.ACCESS_TOKEN_KEY + resource)\n        const expiry = getItem(StorageKey.EXPIRATION_KEY + resource)\n\n        if (expiry && expiry > now() + this.config.expireOffsetSeconds) {\n            return token\n        } else {\n            saveItem(StorageKey.ACCESS_TOKEN_KEY + resource, \"\")\n            saveItem(StorageKey.EXPIRATION_KEY + resource, 0)\n            return null\n        }\n    }\n\n    /**\n     * User information from idtoken.\n     *  @class User\n     *  @property {string} userName - username assigned from upn or email.\n     *  @property {object} profile - properties parsed from idtoken.\n     */\n\n    /**\n     * If user object exists, returns it. Else creates a new user object by decoding id_token from the cache.\n     * @returns {User} user object\n     */\n    getCachedUser() {\n        if (this._user) {\n            return this._user\n        }\n\n        var idtoken = getItem(StorageKey.IDTOKEN)\n        this._user = this._createUser(idtoken)\n        return this._user\n    }\n\n    /**\n     * Adds the passed callback to the array of callbacks for the specified resource and puts the array on the window object.\n     * @param {string}   resource A URI that identifies the resource for which the token is requested.\n     * @param {string}   expectedState A unique identifier (guid).\n     * @param {tokenCallback} callback - The callback provided by the caller. It will be called with token or error.\n     */\n    registerCallback(expectedState: any, resource: string, callback: any) {\n        this._activeRenewals[resource] = expectedState\n\n        if (!this._callBacksMappedToRenewStates[expectedState]) {\n            this._callBacksMappedToRenewStates[expectedState] = []\n        }\n\n        this._callBacksMappedToRenewStates[expectedState].push(callback)\n\n        if (!this._callBackMappedToRenewStates[expectedState]) {\n            this._callBackMappedToRenewStates[expectedState] = (\n                errorDesc,\n                token,\n                error,\n                tokenType,\n            ) => {\n                this._activeRenewals[resource] = null\n\n                for (\n                    var i = 0;\n                    i <\n                    this._callBacksMappedToRenewStates[expectedState].length;\n                    ++i\n                ) {\n                    try {\n                        this._callBacksMappedToRenewStates[expectedState][i](\n                            errorDesc,\n                            token,\n                            error,\n                            tokenType,\n                        )\n                    } catch (error) {\n                        this.logger.warn(error)\n                    }\n                }\n\n                this._callBacksMappedToRenewStates[expectedState] = null\n                this._callBackMappedToRenewStates[expectedState] = null\n            }\n        }\n    }\n\n    // var errorResponse = {error:'', error_description:''};\n    // var token = 'string token';\n    // callback(errorResponse, token)\n    // with callback\n    /**\n     * Acquires access token with hidden iframe\n     * @ignore\n     */\n    _renewToken(resource, callback, responseType = \"token\") {\n        // use iframe to try to renew token\n        // use given resource to create new authz url\n        this.logger.info(\"renewToken is called for resource:\" + resource)\n        var frameHandle = this._addAdalFrame(\"adalRenewFrame\" + resource)\n        var expectedState = guid() + RESOURCE_DELIMETER + resource\n        this.config.state = expectedState\n        // renew happens in iframe, so it keeps javascript context\n        this._renewStates.push(expectedState)\n        this.logger.verbose(\"Renew token Expected state: \" + expectedState)\n        // remove the existing prompt=... query parameter and add prompt=none\n        var urlNavigate = this._urlRemoveQueryStringParameter(\n            this._getNavigateUrl(responseType, resource),\n            \"prompt\",\n        )\n\n        if (responseType === ResponseType.ID_TOKEN) {\n            this._idTokenNonce = guid()\n            saveItem(StorageKey.NONCE_IDTOKEN, this._idTokenNonce, true)\n            urlNavigate += \"&nonce=\" + encodeURIComponent(this._idTokenNonce)\n        }\n\n        urlNavigate = urlNavigate + \"&prompt=none\"\n        urlNavigate = this._addHintParameters(urlNavigate)\n        this.registerCallback(expectedState, resource, callback)\n        this.logger.verbosePii(\"Navigate to:\" + urlNavigate)\n        // @ts-expect-error\n        frameHandle.src = \"about:blank\"\n        this._loadFrameTimeout(\n            urlNavigate,\n            \"adalRenewFrame\" + resource,\n            resource,\n        )\n    }\n\n    /**\n     * Renews idtoken for app's own backend when resource is clientId and calls the callback with token/error\n     * @ignore\n     */\n    _renewIdToken(callback, responseType?: string) {\n        // use iframe to try to renew token\n        this.logger.info(\"renewIdToken is called\")\n        let frameHandle = this._addAdalFrame(\"adalIdTokenFrame\")\n        let expectedState = guid() + RESOURCE_DELIMETER + this.config.clientId\n        this._idTokenNonce = guid()\n        saveItem(StorageKey.NONCE_IDTOKEN, this._idTokenNonce, true)\n        this.config.state = expectedState\n        // renew happens in iframe, so it keeps javascript context\n        this._renewStates.push(expectedState)\n        this.logger.verbose(\"Renew Idtoken Expected state: \" + expectedState)\n        // remove the existing prompt=... query parameter and add prompt=none\n        let resource = responseType || this.config.clientId\n        responseType = responseType || \"id_token\"\n        let urlNavigate = this._urlRemoveQueryStringParameter(\n            this._getNavigateUrl(responseType, resource),\n            \"prompt\",\n        )\n        urlNavigate = urlNavigate + \"&prompt=none\"\n        urlNavigate = this._addHintParameters(urlNavigate)\n        urlNavigate += \"&nonce=\" + encodeURIComponent(this._idTokenNonce)\n        this.registerCallback(expectedState, this.config.clientId, callback)\n        this.logger.verbosePii(\"Navigate to:\" + urlNavigate)\n        // @ts-expect-error\n        frameHandle.src = \"about:blank\"\n        this._loadFrameTimeout(\n            urlNavigate,\n            \"adalIdTokenFrame\",\n            this.config.clientId,\n        )\n    }\n\n    /**\n     * Checks if the authorization endpoint URL contains query string parameters\n     * @ignore\n     */\n    _urlContainsQueryStringParameter = function (name, url) {\n        // regex to detect pattern of a ? or & followed by the name parameter and an equals character\n        var regex = new RegExp(\"[\\\\?&]\" + name + \"=\")\n        return regex.test(url)\n    }\n\n    /**\n     * Removes the query string parameter from the authorization endpoint URL if it exists\n     * @ignore\n     */\n    _urlRemoveQueryStringParameter = function (url, name) {\n        // we remove &name=value, name=value& and name=value\n        // &name=value\n        var regex = new RegExp(\"(\\\\&\" + name + \"=)[^&]+\")\n        url = url.replace(regex, \"\")\n        // name=value&\n        regex = new RegExp(\"(\" + name + \"=)[^&]+&\")\n        url = url.replace(regex, \"\")\n        // name=value\n        regex = new RegExp(\"(\" + name + \"=)[^&]+\")\n        url = url.replace(regex, \"\")\n        return url\n    }\n\n    // Calling _loadFrame but with a timeout to signal failure in loadframeStatus. Callbacks are left\n    // registered when network errors occur and subsequent token requests for same resource are registered to the pending request\n    /**\n     * @ignore\n     */\n    _loadFrameTimeout = function (urlNavigation, frameName, resource) {\n        //set iframe session to pending\n        this.verbose(\"Set loading state to pending for: \" + resource)\n        saveItem(\n            StorageKey.RENEW_STATUS + resource,\n            TokenRenewStatus.InProgress,\n        )\n        this._loadFrame(urlNavigation, frameName)\n\n        setTimeout(() => {\n            if (\n                getItem(StorageKey.RENEW_STATUS + resource) ===\n                TokenRenewStatus.InProgress\n            ) {\n                // fail the iframe session if it's in pending state\n                this.verbose(\n                    \"Loading frame has timed out after: \" +\n                        this.config.loadFrameTimeout / 1000 +\n                        \" seconds for resource \" +\n                        resource,\n                )\n                var expectedState = this._activeRenewals[resource]\n\n                if (\n                    expectedState &&\n                    this._callBackMappedToRenewStates[expectedState]\n                ) {\n                    this._callBackMappedToRenewStates[expectedState](\n                        \"Token renewal operation failed due to timeout\",\n                        null,\n                        \"Token Renewal Failed\",\n                    )\n                }\n\n                saveItem(\n                    StorageKey.RENEW_STATUS + resource,\n                    TokenRenewStatus.Canceled,\n                )\n            }\n        }, this.config.loadFrameTimeout)\n    }\n\n    /**\n     * Loads iframe with authorization endpoint URL\n     * @ignore\n     */\n    _loadFrame(urlNavigate, frameName) {\n        // This trick overcomes iframe navigation in IE\n        // IE does not load the page consistently in iframe\n        this.logger.info(\"LoadFrame: \" + frameName)\n        setTimeout(() => {\n            var frameHandle = this._addAdalFrame(frameName) as any\n            if (frameHandle.src === \"\" || frameHandle.src === \"about:blank\") {\n                frameHandle.src = urlNavigate\n                this._loadFrame(urlNavigate, frameName)\n            }\n        }, 500)\n    }\n\n    /**\n     * @callback tokenCallback\n     * @param {string} error_description error description returned from AAD if token request fails.\n     * @param {string} token token returned from AAD if token request is successful.\n     * @param {string} error error message returned from AAD if token request fails.\n     */\n\n    /**\n     * Acquires token from the cache if it is not expired. Otherwise sends request to AAD to obtain a new token.\n     * @param {string}   resource  ResourceUri identifying the target resource\n     * @param {tokenCallback} callback -  The callback provided by the caller. It will be called with token or error.\n     */\n    acquireToken(resource, callback) {\n        if (!resource) {\n            const error = \"resource is required\"\n            this.logger.warn(error)\n            callback(error, null, error)\n            return\n        }\n\n        var token = this.getCachedToken(resource)\n\n        if (token) {\n            this.logger.info(\n                \"Token is already in cache for resource:\" + resource,\n            )\n            callback(null, token, null)\n            return\n        }\n\n        if (\n            !this._user &&\n            !(\n                this.config.extraQueryParameter &&\n                this.config.extraQueryParameter.indexOf(\"login_hint\") !== -1\n            )\n        ) {\n            const error = \"User login is required\"\n            this.logger.warn(error)\n            callback(error, null, error)\n            return\n        }\n\n        // renew attempt with iframe\n        // Already renewing for this resource, callback when we get the token.\n        if (this._activeRenewals[resource]) {\n            // Active renewals contains the state for each renewal.\n            this.registerCallback(\n                this._activeRenewals[resource],\n                resource,\n                callback,\n            )\n        } else {\n            this._requestType = RequestType.RENEW_TOKEN\n            if (resource === this.config.clientId) {\n                // App uses idtoken to send to api endpoints\n                // Default resource is tracked as clientid to store this token\n                if (this._user) {\n                    this.logger.verbose(\"renewing idtoken\")\n                    this._renewIdToken(callback)\n                } else {\n                    this.logger.verbose(\"renewing idtoken and access_token\")\n                    this._renewIdToken(callback, ResponseType.ID_TOKEN)\n                }\n            } else {\n                if (this._user) {\n                    this.logger.verbose(\"renewing access_token\")\n                    this._renewToken(resource, callback)\n                } else {\n                    this.logger.verbose(\"renewing idtoken and access_token\")\n                    this._renewToken(resource, callback, ResponseType.ID_TOKEN)\n                }\n            }\n        }\n    }\n\n    /**\n     * Acquires token (interactive flow using a popUp window) by sending request to AAD to obtain a new token.\n     * @param {string}   resource  ResourceUri identifying the target resource\n     * @param {string}   extraQueryParameters  extraQueryParameters to add to the authentication request\n     * @param {tokenCallback} callback -  The callback provided by the caller. It will be called with token or error.\n     */\n    acquireTokenPopup(resource, extraQueryParameters, claims, callback) {\n        if (!this.ensureCanAcquireToken(resource)) {\n            return\n        }\n\n        var expectedState = guid() + RESOURCE_DELIMETER + resource\n        this.config.state = expectedState\n        this._renewStates.push(expectedState)\n        this._requestType = RequestType.RENEW_TOKEN\n        this.logger.verbose(\"Renew token Expected state: \" + expectedState)\n        // remove the existing prompt=... query parameter and add prompt=select_account\n        var urlNavigate = this._urlRemoveQueryStringParameter(\n            this._getNavigateUrl(\"token\", resource),\n            \"prompt\",\n        )\n        urlNavigate = urlNavigate + \"&prompt=select_account\"\n\n        if (extraQueryParameters) {\n            urlNavigate += extraQueryParameters\n        }\n\n        if (claims && urlNavigate.indexOf(\"&claims\") === -1) {\n            urlNavigate += \"&claims=\" + encodeURIComponent(claims)\n        } else if (claims && urlNavigate.indexOf(\"&claims\") !== -1) {\n            throw new Error(\"Claims cannot be passed as an extraQueryParameter\")\n        }\n\n        urlNavigate = this._addHintParameters(urlNavigate)\n        this._acquireTokenInProgress = true\n        this.logger.info(\n            \"acquireToken interactive is called for the resource \" + resource,\n        )\n        this.registerCallback(expectedState, resource, callback)\n        this._loginPopup(urlNavigate, resource, callback)\n    }\n\n    /**\n     * Acquires token (interactive flow using a redirect) by sending request to AAD to obtain a new token. In this case the callback passed in the Authentication\n     * request constructor will be called.\n     * @param {string}   resource  ResourceUri identifying the target resource\n     * @param {string}   extraQueryParameters  extraQueryParameters to add to the authentication request\n     */\n    acquireTokenRedirect(resource, extraQueryParameters, claims) {\n        if (!this.ensureCanAcquireToken(resource)) {\n            return\n        }\n\n        const expectedState = guid() + RESOURCE_DELIMETER + resource\n        this.config.state = expectedState\n        this.logger.verbose(\"Renew token Expected state: \" + expectedState)\n\n        // remove the existing prompt=... query parameter and add prompt=select_account\n        var urlNavigate = this._urlRemoveQueryStringParameter(\n            this._getNavigateUrl(\"token\", resource),\n            \"prompt\",\n        )\n        urlNavigate = urlNavigate + \"&prompt=select_account\"\n        if (extraQueryParameters) {\n            urlNavigate += extraQueryParameters\n        }\n\n        if (claims && urlNavigate.indexOf(\"&claims\") === -1) {\n            urlNavigate += \"&claims=\" + encodeURIComponent(claims)\n        } else if (claims && urlNavigate.indexOf(\"&claims\") !== -1) {\n            throw new Error(\"Claims cannot be passed as an extraQueryParameter\")\n        }\n\n        urlNavigate = this._addHintParameters(urlNavigate)\n        this._acquireTokenInProgress = true\n        this.logger.info(\n            \"acquireToken interactive is called for the resource \" + resource,\n        )\n        saveItem(StorageKey.LOGIN_REQUEST, window.location.href)\n        saveItem(StorageKey.STATE_RENEW, expectedState, true)\n        this.promptUser(urlNavigate)\n    }\n\n\n    ensureCanAcquireToken(resource: string): boolean {\n        let error: string | undefined\n        if (!resource) {\n            error = \"Resource is required\"\n        } else if (!this._user) {\n            error = \"User login is required\"\n        } else if (this._acquireTokenInProgress) {\n            error = \"Acquire token interactive is already in progress\"\n        }\n        if (error) {\n            this.logger.warn(error)\n            this.config.callback(\n                error,\n                null,\n                error,\n            )\n            return false\n        }\n        return true\n    }\n\n    /**\n     * Redirects the browser to Azure AD authorization endpoint.\n     * @param {string}   urlNavigate  Url of the authorization endpoint.\n     */\n    promptUser(urlNavigate: string) {\n        if (urlNavigate) {\n            this.logger.infoPii(\"Navigate to:\" + urlNavigate)\n            window.location.replace(urlNavigate)\n        } else {\n            this.logger.info(\"Navigate url is empty\")\n        }\n    }\n\n    /**\n     * Clears cache items.\n     */\n    clearCache() {\n        saveItem(StorageKey.LOGIN_REQUEST, \"\")\n        saveItem(StorageKey.SESSION_STATE, \"\")\n        saveItem(StorageKey.STATE_LOGIN, \"\")\n        saveItem(StorageKey.STATE_RENEW, \"\")\n        this._renewStates = []\n        saveItem(StorageKey.NONCE_IDTOKEN, \"\")\n        saveItem(StorageKey.IDTOKEN, \"\")\n        saveItem(StorageKey.ERROR, \"\")\n        saveItem(StorageKey.ERROR_DESCRIPTION, \"\")\n        saveItem(StorageKey.LOGIN_ERROR, \"\")\n        saveItem(StorageKey.LOGIN_ERROR, \"\")\n        var keys = getItem(StorageKey.TOKEN_KEYS) as any\n\n        if (!isEmpty(keys)) {\n            keys = keys.split(RESOURCE_DELIMETER)\n            for (var i = 0; i < keys.length && keys[i] !== \"\"; i++) {\n                saveItem(StorageKey.ACCESS_TOKEN_KEY + keys[i], \"\")\n                saveItem(StorageKey.EXPIRATION_KEY + keys[i], 0)\n            }\n        }\n\n        saveItem(StorageKey.TOKEN_KEYS, \"\")\n    }\n\n    /**\n     * Clears cache items for a given resource.\n     * @param {string}  resource a URI that identifies the resource.\n     */\n    clearCacheForResource(resource: string) {\n        saveItem(StorageKey.STATE_RENEW, \"\")\n        saveItem(StorageKey.ERROR, \"\")\n        saveItem(StorageKey.ERROR_DESCRIPTION, \"\")\n\n        if (this._hasResource(resource)) {\n            saveItem(StorageKey.ACCESS_TOKEN_KEY + resource, \"\")\n            saveItem(StorageKey.EXPIRATION_KEY + resource, 0)\n        }\n    }\n\n    /**\n     * Redirects user to logout endpoint.\n     * After logout, it will redirect to postLogoutRedirectUri if added as a property on the config object.\n     */\n    logOut() {\n        this.clearCache()\n        this._user = null\n        let urlNavigate: string\n\n        if (this.config.logOutUri) {\n            urlNavigate = this.config.logOutUri\n        } else {\n            let logout = \"\"\n            if (this.config.postLogoutRedirectUri) {\n                logout =\n                    \"post_logout_redirect_uri=\" +\n                    encodeURIComponent(this.config.postLogoutRedirectUri)\n            }\n\n            urlNavigate =\n                this.config.instance +\n                this.config.tenant +\n                \"/oauth2/logout?\" +\n                logout\n        }\n\n        this.logger.infoPii(\"Logout navigate to: \" + urlNavigate)\n        this.promptUser(urlNavigate)\n    }\n\n    getUser() {\n        if (this._user) {\n            return this._user\n        }\n\n        const idToken = getItem(StorageKey.IDTOKEN)\n        if (idToken) {\n            return this._user = this._createUser(idToken)\n        }\n    }\n\n    /**\n     * Adds login_hint to authorization URL which is used to pre-fill the username field of sign in page for the user if known ahead of time.\n     * domain_hint can be one of users/organisations which when added skips the email based discovery process of the user.\n     * @ignore\n     */\n    _addHintParameters = function (urlNavigate) {\n        //If you dont use prompt=none, then if the session does not exist, there will be a failure.\n        //If sid is sent alongside domain or login hints, there will be a failure since request is ambiguous.\n        //If sid is sent with a prompt value other than none or attempt_none, there will be a failure since the request is ambiguous.\n\n        if (this._user && this._user.profile) {\n            if (\n                this._user.profile.sid &&\n                urlNavigate.indexOf(\"&prompt=none\") !== -1\n            ) {\n                // don't add sid twice if user provided it in the extraQueryParameter value\n                if (\n                    !this._urlContainsQueryStringParameter(\"sid\", urlNavigate)\n                ) {\n                    // add sid\n                    urlNavigate +=\n                        \"&sid=\" + encodeURIComponent(this._user.profile.sid)\n                }\n            } else if (this._user.profile.upn) {\n                // don't add login_hint twice if user provided it in the extraQueryParameter value\n                if (\n                    !this._urlContainsQueryStringParameter(\n                        \"login_hint\",\n                        urlNavigate,\n                    )\n                ) {\n                    // add login_hint\n                    urlNavigate +=\n                        \"&login_hint=\" +\n                        encodeURIComponent(this._user.profile.upn)\n                }\n                // don't add domain_hint twice if user provided it in the extraQueryParameter value\n                if (\n                    !this._urlContainsQueryStringParameter(\n                        \"domain_hint\",\n                        urlNavigate,\n                    ) &&\n                    this._user.profile.upn.indexOf(\"@\") > -1\n                ) {\n                    var parts = this._user.profile.upn.split(\"@\")\n                    // local part can include @ in quotes. Sending last part handles that.\n                    urlNavigate +=\n                        \"&domain_hint=\" +\n                        encodeURIComponent(parts[parts.length - 1])\n                }\n            }\n        }\n\n        return urlNavigate\n    }\n\n    /**\n     * Creates a user object by decoding the id_token\n     * @ignore\n     */\n    _createUser(idToken) {\n        const json = this._extractIdToken(idToken)\n        if (!has(json, \"aud\")) {\n            return\n        }\n\n        if (json.aud.toLowerCase() !== this.config.clientId.toLowerCase()) {\n            this.logger.warn(\"IdToken has invalid aud field\")\n        } else {\n            return {\n                userName: json.upn || json.email,\n                profile: json,\n            }\n        }\n    }\n\n    /**\n     * Gets login error\n     * @returns {string} error message related to login.\n     */\n    getLoginError() {\n        return getItem(StorageKey.LOGIN_ERROR)\n    }\n\n    /**\n     * Request info object created from the response received from AAD.\n     *  @class RequestInfo\n     *  @property {object} parameters - object comprising of fields such as id_token/error, session_state, state, e.t.c.\n     *  @property {REQUEST_TYPE} requestType - either LOGIN, RENEW_TOKEN or UNKNOWN.\n     *  @property {boolean} stateMatch - true if state is valid, false otherwise.\n     *  @property {string} stateResponse - unique guid used to match the response with the request.\n     *  @property {boolean} valid - true if requestType contains id_token, access_token or error, false otherwise.\n     */\n\n    /**\n     * Creates a requestInfo object from the URL fragment and returns it.\n     * @returns {RequestInfo} an object created from the redirect response from AAD comprising of the keys - parameters, requestType, stateMatch, stateResponse and valid.\n     */\n    getRequestInfo(hash) {\n        const requestInfo = {\n            valid: false,\n            parameters: {},\n            stateMatch: false,\n            stateResponse: \"\",\n            requestType: RequestType.UNKNOWN,\n        }\n\n        const parameters = deserialize(getHash(hash)) as any\n        if (!parameters) {\n            return requestInfo\n        }\n\n        requestInfo.parameters = parameters\n        if (\n            has(parameters, ERROR_DESCRIPTION) ||\n            has(parameters, ACCESS_TOKEN) ||\n            has(parameters, ID_TOKEN)\n        ) {\n            requestInfo.valid = true\n\n            // which call\n            if (parameters.hasOwnProperty(\"state\")) {\n                this.logger.verbose(\"State: \" + parameters.state)\n                requestInfo.stateResponse = parameters.state\n            } else {\n                this.logger.warn(\"No state returned\")\n                return requestInfo\n            }\n\n            // async calls can fire iframe and login request at the same time if developer does not use the API as expected\n            // incoming callback needs to be looked up to find the request type\n            if (this._matchState(requestInfo)) {\n                // loginRedirect or acquireTokenRedirect\n                return requestInfo\n            }\n\n            // external api requests may have many renewtoken requests for different resource\n            if (!requestInfo.stateMatch && window.parent) {\n                requestInfo.requestType = this._requestType\n                for (const state of this._renewStates) {\n                    if (state === requestInfo.stateResponse) {\n                        requestInfo.stateMatch = true\n                        break\n                    }\n                }\n            }\n        }\n        return requestInfo\n    }\n\n    /**\n     * Matches nonce from the request with the response.\n     * @ignore\n     */\n    _matchNonce(user) {\n        const requestNonce = getItem(StorageKey.NONCE_IDTOKEN)\n        if (requestNonce) {\n            for (const nonce of requestNonce.split(CACHE_DELIMETER)) {\n                if (nonce === user.profile.nonce) {\n                    return true\n                }\n            }\n        }\n        return false\n    }\n\n    /**\n     * Matches state from the request with the response.\n     * @ignore\n     */\n    _matchState(requestInfo) {\n        const loginStates = getItem(StorageKey.STATE_LOGIN)\n        if (loginStates) {\n            for (const state of loginStates.split(CACHE_DELIMETER)) {\n                if (state === requestInfo.stateResponse) {\n                    requestInfo.requestType = RequestType.LOGIN\n                    requestInfo.stateMatch = true\n                    return true\n                }\n            }\n        }\n\n        const acquireTokenStates = getItem(StorageKey.STATE_RENEW)\n        if (acquireTokenStates) {\n            for (const state of acquireTokenStates.split(CACHE_DELIMETER)) {\n                if (state === requestInfo.stateResponse) {\n                    requestInfo.requestType = RequestType.RENEW_TOKEN\n                    requestInfo.stateMatch = true\n                    return true\n                }\n            }\n        }\n\n        return false\n    }\n\n    /**\n     * Saves token or error received in the response from AAD in the cache. In case of id_token, it also creates the user object.\n     */\n    saveTokenFromHash(requestInfo) {\n        this.logger.info(\n            \"State status:\" +\n                requestInfo.stateMatch +\n                \"; Request type:\" +\n                requestInfo.requestType,\n        )\n        saveItem(StorageKey.ERROR, \"\")\n        saveItem(StorageKey.ERROR_DESCRIPTION, \"\")\n\n        var resource = getResourceFromState(requestInfo.stateResponse)\n\n        // Record error\n        if (requestInfo.parameters.hasOwnProperty(ERROR_DESCRIPTION)) {\n            this.logger.infoPii(\n                \"Error :\" +\n                    requestInfo.parameters.error +\n                    \"; Error description:\" +\n                    requestInfo.parameters[ERROR_DESCRIPTION],\n            )\n            saveItem(StorageKey.ERROR, requestInfo.parameters.error)\n            saveItem(\n                StorageKey.ERROR_DESCRIPTION,\n                requestInfo.parameters[ERROR_DESCRIPTION],\n            )\n\n            if (requestInfo.requestType === RequestType.LOGIN) {\n                this._loginInProgress = false\n                saveItem(\n                    StorageKey.LOGIN_ERROR,\n                    requestInfo.parameters.error_description,\n                )\n            }\n        } else {\n            // It must verify the state from redirect\n            if (requestInfo.stateMatch) {\n                // record tokens to storage if exists\n                this.logger.info(\"State is right\")\n                if (requestInfo.parameters.hasOwnProperty(SESSION_STATE)) {\n                    saveItem(\n                        StorageKey.SESSION_STATE,\n                        requestInfo.parameters[SESSION_STATE],\n                    )\n                }\n\n                var keys\n\n                if (requestInfo.parameters.hasOwnProperty(ACCESS_TOKEN)) {\n                    this.logger.info(\"Fragment has access token\")\n\n                    if (!this._hasResource(resource)) {\n                        keys = getItem(StorageKey.TOKEN_KEYS) || \"\"\n                        saveItem(\n                            StorageKey.TOKEN_KEYS,\n                            keys + resource + RESOURCE_DELIMETER,\n                        )\n                    }\n\n                    // save token with related resource\n                    saveItem(\n                        StorageKey.ACCESS_TOKEN_KEY + resource,\n                        requestInfo.parameters[ACCESS_TOKEN],\n                    )\n                    saveItem(\n                        StorageKey.EXPIRATION_KEY + resource,\n                        this._expiresIn(requestInfo.parameters[EXPIRES_IN]),\n                    )\n                }\n\n                if (requestInfo.parameters.hasOwnProperty(ID_TOKEN)) {\n                    // this.info(\"Fragment has id token\")\n                    this._loginInProgress = false\n                    this._user = this._createUser(\n                        requestInfo.parameters[ID_TOKEN],\n                    )\n                    if (this._user && this._user.profile) {\n                        if (!this._matchNonce(this._user)) {\n                            saveItem(\n                                StorageKey.LOGIN_ERROR,\n                                \"Nonce received: \" +\n                                    this._user.profile.nonce +\n                                    \" is not same as requested: \" +\n                                    getItem(StorageKey.NONCE_IDTOKEN),\n                            )\n                            this._user = null\n                        } else {\n                            saveItem(\n                                StorageKey.IDTOKEN,\n                                requestInfo.parameters[ID_TOKEN],\n                            )\n\n                            // Save idtoken as access token for app itself\n                            resource = this.config.loginResource\n                                ? this.config.loginResource\n                                : this.config.clientId\n\n                            if (!this._hasResource(resource)) {\n                                keys = getItem(StorageKey.TOKEN_KEYS) || \"\"\n                                saveItem(\n                                    StorageKey.TOKEN_KEYS,\n                                    keys + resource + RESOURCE_DELIMETER,\n                                )\n                            }\n\n                            saveItem(\n                                StorageKey.ACCESS_TOKEN_KEY + resource,\n                                requestInfo.parameters[ID_TOKEN],\n                            )\n                            saveItem(\n                                StorageKey.EXPIRATION_KEY + resource,\n                                this._user.profile.exp,\n                            )\n                        }\n                    } else {\n                        requestInfo.parameters[\"error\"] = \"invalid id_token\"\n                        requestInfo.parameters[\"error_description\"] =\n                            \"Invalid id_token. id_token: \" +\n                            requestInfo.parameters[ID_TOKEN]\n                        saveItem(StorageKey.ERROR, \"invalid id_token\")\n                        saveItem(\n                            StorageKey.ERROR_DESCRIPTION,\n                            \"Invalid id_token. id_token: \" +\n                                requestInfo.parameters[ID_TOKEN],\n                        )\n                    }\n                }\n            } else {\n                requestInfo.parameters[\"error\"] = \"Invalid_state\"\n                requestInfo.parameters[\"error_description\"] =\n                    \"Invalid_state. state: \" + requestInfo.stateResponse\n                saveItem(StorageKey.ERROR, \"Invalid_state\")\n                saveItem(\n                    StorageKey.ERROR_DESCRIPTION,\n                    \"Invalid_state. state: \" + requestInfo.stateResponse,\n                )\n            }\n        }\n\n        saveItem(StorageKey.RENEW_STATUS + resource, TokenRenewStatus.Completed)\n    }\n\n    /**\n     * Gets resource for given endpoint if mapping is provided with config.\n     * @param {string} endpoint  -  The URI for which the resource Id is requested.\n     * @returns {string} resource for this API endpoint.\n     */\n    getResourceForEndpoint(endpoint: string) {\n        // if user specified list of anonymous endpoints, no need to send token to these endpoints, return null.\n        if (this.config && this.config.anonymousEndpoints) {\n            for (var i = 0; i < this.config.anonymousEndpoints.length; i++) {\n                if (endpoint.indexOf(this.config.anonymousEndpoints[i]) > -1) {\n                    return null\n                }\n            }\n        }\n\n        if (this.config && this.config.endpoints) {\n            for (var configEndpoint in this.config.endpoints) {\n                // configEndpoint is like /api/Todo requested endpoint can be /api/Todo/1\n                if (endpoint.indexOf(configEndpoint) > -1) {\n                    return this.config.endpoints[configEndpoint]\n                }\n            }\n        }\n\n        // default resource will be clientid if nothing specified\n        // App will use idtoken for calls to itself\n        // check if it's staring from http or https, needs to match with app host\n        if (\n            endpoint.indexOf(\"http://\") > -1 ||\n            endpoint.indexOf(\"https://\") > -1\n        ) {\n            if (\n                this._getHostFromUri(endpoint) ===\n                this._getHostFromUri(this.config.redirectUri)\n            ) {\n                return this.config.loginResource\n            }\n        } else {\n            // in angular level, the url for $http interceptor call could be relative url,\n            // if it's relative call, we'll treat it as app backend call.\n            return this.config.loginResource\n        }\n\n        // if not the app's own backend or not a domain listed in the endpoints structure\n        return null\n    }\n\n    /**\n     * Strips the protocol part of the URL and returns it.\n     * @ignore\n     */\n    _getHostFromUri(uri: string) {\n        // remove http:// or https:// from uri\n        var extractedUri = String(uri).replace(/^(https?:)\\/\\//, \"\")\n        extractedUri = extractedUri.split(\"/\")[0]\n        return extractedUri\n    }\n\n    /**\n     * This method must be called for processing the response received from AAD. It extracts the hash, processes the token or error, saves it in the cache and calls the registered callbacks with the result.\n     * @param {string} [hash=window.location.hash] - Hash fragment of Url.\n     */\n    handleWindowCallback(hash: string) {\n        // This is for regular javascript usage for redirect handling\n        // need to make sure this is for callback\n        if (hash == null) {\n            hash = window.location.hash\n        }\n\n        if (isCallback(hash)) {\n            var self: Adal = null as any\n            var isPopup = false\n\n            if (\n                this._openedWindows.length > 0 &&\n                this._openedWindows[this._openedWindows.length - 1].opener &&\n                this._openedWindows[this._openedWindows.length - 1].opener\n                    ._adalInstance\n            ) {\n                self = this._openedWindows[this._openedWindows.length - 1]\n                    .opener._adalInstance\n                isPopup = true\n            }\n            // @ts-ignore\n            else if (window.parent && window.parent._adalInstance) {\n                // @ts-ignore\n                self = window.parent._adalInstance\n            }\n\n            let requestInfo = self.getRequestInfo(hash) as any\n            let tokenReceivedCallback: any\n\n            if (isPopup || window.parent !== window) {\n                tokenReceivedCallback =\n                    self._callBackMappedToRenewStates[requestInfo.stateResponse]\n            } else {\n                tokenReceivedCallback = self.config.callback\n            }\n\n            // self.info(\"Returned from redirect url\")\n            self.saveTokenFromHash(requestInfo)\n\n            let token: any\n            let tokenType: any\n            if (\n                requestInfo.requestType === RequestType.RENEW_TOKEN &&\n                window.parent\n            ) {\n                if (window.parent !== window) {\n                    self.logger.verbose(\n                        \"Window is in iframe, acquiring token silently\",\n                    )\n                } else {\n                    self.logger.verbose(\n                        \"acquiring token interactive in progress\",\n                    )\n                }\n\n                token =\n                    requestInfo.parameters[ACCESS_TOKEN] ||\n                    requestInfo.parameters[ID_TOKEN]\n                tokenType = ACCESS_TOKEN\n            } else if (requestInfo.requestType === RequestType.LOGIN) {\n                token = requestInfo.parameters[ID_TOKEN]\n                tokenType = ID_TOKEN\n            }\n\n            var errorDesc = requestInfo.parameters[ERROR_DESCRIPTION]\n            var error = requestInfo.parameters[ERROR]\n            try {\n                if (tokenReceivedCallback) {\n                    tokenReceivedCallback(errorDesc, token, error, tokenType)\n                }\n            } catch (err) {\n                self.logger.error(\n                    \"Error occurred in user defined callback function: \" + err,\n                )\n            }\n\n            if (window.parent === window && !isPopup) {\n                if (self.config.navigateToLoginRequestUrl) {\n                    window.location.href = getItem(StorageKey.LOGIN_REQUEST)\n                } else {\n                    window.location.hash = \"\"\n                }\n            }\n        }\n    }\n\n    /**\n     * Constructs the authorization endpoint URL and returns it.\n     * @ignore\n     */\n    _getNavigateUrl(responseType: string, resource?: string) {\n        const urlNavigate =\n            this.config.instance +\n            this.config.tenant +\n            \"/oauth2/authorize\" +\n            this._serialize(responseType, this.config, resource) +\n            \"&x-client-SKU=Js&x-client-Ver=\" +\n            VERSION\n        this.logger.info(\"Navigate url:\" + urlNavigate)\n        return urlNavigate\n    }\n\n    /**\n     * Returns the decoded id_token.\n     * @ignore\n     */\n    _extractIdToken(encodedIdToken: string) {\n        // id token will be decoded to get the username\n        var decodedToken = this._decodeJwt(encodedIdToken)\n\n        if (!decodedToken) {\n            return\n        }\n\n        try {\n            var base64IdToken = decodedToken.JWSPayload\n            var base64Decoded = this._base64DecodeStringUrlSafe(base64IdToken)\n\n            if (!base64Decoded) {\n                this.logger.info(\n                    \"The returned id_token could not be base64 url safe decoded.\",\n                )\n                return\n            }\n\n            // ECMA script has JSON built-in support\n            return JSON.parse(base64Decoded)\n        } catch (err) {\n            this.logger.error(\"The returned id_token could not be decoded\", err)\n        }\n    }\n\n    /**\n     * Decodes a string of data which has been encoded using base-64 encoding.\n     * @ignore\n     */\n    _base64DecodeStringUrlSafe(base64IdToken: string) {\n        base64IdToken = base64IdToken.replace(/-/g, \"+\").replace(/_/g, \"/\")\n        return decodeURIComponent(escape(window.atob(base64IdToken)))\n    }\n\n    /**\n     * Decodes an id token into an object with header, payload and signature fields.\n     * @ignore\n     */\n    // Adal.node js crack function\n    _decodeJwt(jwtToken: string) {\n        if (isEmpty(jwtToken)) {\n            return null\n        }\n\n        var idTokenPartsRegex = /^([^\\.\\s]*)\\.([^\\.\\s]+)\\.([^\\.\\s]*)$/\n\n        var matches = idTokenPartsRegex.exec(jwtToken)\n\n        if (!matches || matches.length < 4) {\n            this.logger.warn(\"The returned id_token is not parseable.\")\n            return null\n        }\n\n        var crackedToken = {\n            header: matches[1],\n            JWSPayload: matches[2],\n            JWSSig: matches[3],\n        }\n\n        return crackedToken\n    }\n\n    /**\n     * Converts string to represent binary data in ASCII string format by translating it into a radix-64 representation and returns it\n     * @ignore\n     */\n    _convertUrlSafeToRegularBase64EncodedString(str: string) {\n        return str.replace(\"-\", \"+\").replace(\"_\", \"/\")\n    }\n\n    /**\n     * Serializes the parameters for the authorization endpoint URL and returns the serialized uri string.\n     * @ignore\n     */\n    _serialize(responseType: string, obj: any, resource?: string) {\n        var str: string[] = []\n\n        if (obj !== null) {\n            str.push(\"?response_type=\" + responseType)\n            str.push(\"client_id=\" + encodeURIComponent(obj.clientId))\n            if (resource) {\n                str.push(\"resource=\" + encodeURIComponent(resource))\n            }\n\n            str.push(\"redirect_uri=\" + encodeURIComponent(obj.redirectUri))\n            str.push(\"state=\" + encodeURIComponent(obj.state))\n\n            if (obj.hasOwnProperty(\"slice\")) {\n                str.push(\"slice=\" + encodeURIComponent(obj.slice))\n            }\n\n            if (obj.hasOwnProperty(\"extraQueryParameter\")) {\n                str.push(obj.extraQueryParameter)\n            }\n\n            var correlationId = obj.correlationId ? obj.correlationId : guid()\n            str.push(\"client-request-id=\" + encodeURIComponent(correlationId))\n        }\n\n        return str.join(\"&\")\n    }\n\n    /**\n     * Calculates the expires in value in milliseconds for the acquired token\n     * @ignore\n     */\n    _expiresIn(expires: any) {\n        // if AAD did not send \"expires_in\" property, use default expiration of 3599 seconds, for some reason AAD sends 3599 as \"expires_in\" value instead of 3600\n        if (!expires) expires = 3599\n        return now() + parseInt(expires, 10)\n    }\n\n    /**\n     * Adds the hidden iframe for silent token renewal\n     * @ignore\n     */\n    _addAdalFrame(iframeId: string) {\n        if (!iframeId) {\n            return\n        }\n\n        this.logger.info(\"Add adal frame to document:\" + iframeId)\n        var adalFrame = document.getElementById(iframeId)\n\n        if (!adalFrame) {\n            if (\n                document.createElement &&\n                document.documentElement &&\n                (window[\"opera\"] ||\n                    window.navigator.userAgent.indexOf(\"MSIE 5.0\") === -1)\n            ) {\n                var ifr = document.createElement(\"iframe\") as any\n                ifr.setAttribute(\"id\", iframeId)\n                ifr.setAttribute(\"aria-hidden\", \"true\")\n                ifr.style.visibility = \"hidden\"\n                ifr.style.position = \"absolute\"\n                ifr.style.width = ifr.style.height = ifr.borderWidth = \"0px\"\n\n                adalFrame = document\n                    .getElementsByTagName(\"body\")[0]\n                    .appendChild(ifr)\n            } else if (document.body && document.body.insertAdjacentHTML) {\n                document.body.insertAdjacentHTML(\n                    \"beforeEnd\" as any,\n                    '<iframe name=\"' +\n                        iframeId +\n                        '\" id=\"' +\n                        iframeId +\n                        '\" style=\"display:none\"></iframe>',\n                )\n            }\n            if (window.frames && window.frames[iframeId]) {\n                adalFrame = window.frames[iframeId]\n            }\n        }\n\n        return adalFrame\n    }\n}\n\n/**\n * Saves the key-value pair in the cache\n * @ignore\n */\nfunction saveItem(key: string, value: any, preserve = false) {\n    if (preserve) {\n        const old = getItem(key) || \"\"\n        Storage.setItem(key, old + value + CACHE_DELIMETER)\n    } else {\n        Storage.setItem(key, value)\n    }\n}\n\n/**\n * Searches the value for the given key in the cache\n * @ignore\n */\nfunction getItem(key: string): any {\n    return Storage.getItem(key)\n}\n\n/**\n * Returns the anchor part(#) of the URL\n * @ignore\n */\nfunction getHash(hash: string) {\n    if (hash.indexOf(\"#/\") > -1) {\n        hash = hash.substring(hash.indexOf(\"#/\") + 2)\n    } else if (hash.indexOf(\"#\") > -1) {\n        hash = hash.substring(1)\n    }\n    return hash\n}\n\n/**\n * Checks if the URL fragment contains access token, id token or error_description.\n * @param {string} hash  -  Hash passed from redirect page\n * @returns {Boolean} true if response contains id_token, access_token or error, false otherwise.\n */\nfunction isCallback(hash: string) {\n    const parameters = deserialize(getHash(hash))\n    return (\n        has(parameters, ERROR_DESCRIPTION) ||\n        has(parameters, ACCESS_TOKEN) ||\n        has(parameters, ID_TOKEN)\n    )\n}\n\n/**\n * Parses the query string parameters into a key-value pair object.\n * @ignore\n */\nfunction deserialize(query: string) {\n    var match,\n        pl = /\\+/g, // Regex for replacing addition symbol with a space\n        search = /([^&=]+)=([^&]*)/g,\n        decode = (s: string) => decodeURIComponent(s.replace(pl, \" \")),\n        obj = {}\n    match = search.exec(query)\n\n    while (match) {\n        obj[decode(match[1])] = decode(match[2])\n        match = search.exec(query)\n    }\n\n    return obj\n}\n\n/**\n * Extracts resource value from state.\n * @ignore\n */\nfunction getResourceFromState(state) {\n    if (state) {\n        var splitIndex = state.indexOf(RESOURCE_DELIMETER)\n        if (splitIndex > -1 && splitIndex + 1 < state.length) {\n            return state.substring(splitIndex + 1)\n        }\n    }\n\n    return \"\"\n}\n\nfunction isEmpty(str: string): boolean {\n    return typeof str === \"undefined\" || !str || 0 === str.length\n}\n\nfunction has(obj: any, key: string): boolean {\n    return !!obj && Object.hasOwnProperty.call(obj, key)\n}\n\nfunction now() {\n    return Math.round(Date.now() / 1000)\n}\n\n/**\n * Generates RFC4122 version 4 guid (128 bits)\n * @ignore\n */\nfunction guid(): string {\n    // RFC4122: The version 4 UUID is meant for generating UUIDs from truly-random or\n    // pseudo-random numbers.\n    // The algorithm is as follows:\n    //     Set the two most significant bits (bits 6 and 7) of the\n    //        clock_seq_hi_and_reserved to zero and one, respectively.\n    //     Set the four most significant bits (bits 12 through 15) of the\n    //        time_hi_and_version field to the 4-bit version number from\n    //        Section 4.1.3. Version4\n    //     Set all the other bits to randomly (or pseudo-randomly) chosen\n    //     values.\n    // UUID                   = time-low \"-\" time-mid \"-\"time-high-and-version \"-\"clock-seq-reserved and low(2hexOctet)\"-\" node\n    // time-low               = 4hexOctet\n    // time-mid               = 2hexOctet\n    // time-high-and-version  = 2hexOctet\n    // clock-seq-and-reserved = hexOctet:\n    // clock-seq-low          = hexOctet\n    // node                   = 6hexOctet\n    // Format: xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx\n    // y could be 1000, 1001, 1010, 1011 since most significant two bits needs to be 10\n    // y values are 8, 9, A, B\n    // @ts-expect-error\n    var cryptoObj = window.crypto || window.msCrypto // for IE 11\n    var buffer = new Uint8Array(16)\n    cryptoObj.getRandomValues(buffer)\n    //buffer[6] and buffer[7] represents the time_hi_and_version field. We will set the four most significant bits (4 through 7) of buffer[6] to represent decimal number 4 (UUID version number).\n    buffer[6] |= 0x40 //buffer[6] | 01000000 will set the 6 bit to 1.\n    buffer[6] &= 0x4f //buffer[6] & 01001111 will set the 4, 5, and 7 bit to 0 such that bits 4-7 == 0100 = \"4\".\n    //buffer[8] represents the clock_seq_hi_and_reserved field. We will set the two most significant bits (6 and 7) of the clock_seq_hi_and_reserved to zero and one, respectively.\n    buffer[8] |= 0x80 //buffer[8] | 10000000 will set the 7 bit to 1.\n    buffer[8] &= 0xbf //buffer[8] & 10111111 will set the 6 bit to 0.\n    buffer = buffer.map((n: any) => {\n        let hex = n.toString(16)\n        while (hex.length < 2) {\n            hex = \"0\" + hex\n        }\n        return hex\n    })\n    return (\n        buffer[0] +\n        buffer[1] +\n        buffer[2] +\n        buffer[3] +\n        \"-\" +\n        buffer[4] +\n        buffer[5] +\n        \"-\" +\n        buffer[6] +\n        buffer[7] +\n        \"-\" +\n        buffer[8] +\n        buffer[9] +\n        \"-\" +\n        buffer[10] +\n        buffer[11] +\n        buffer[12] +\n        buffer[13] +\n        buffer[14] +\n        buffer[15]\n    )\n}\n"],"names":["StorageKey","Storage","supportsStorage","type","storage","window","setItem","getItem","removeItem","localStorage","sessionStorage","LogLevel","LOG_LEVEL_LABELS","[object Object]","Error","Warn","Info","Verbose","Logger","constructor","this","log","level","message","error","containsPii","pii","formattedMessage","Date","toUTCString","correlationId","timestamp","stack","console","warn","info","verbose","errorPii","warnPii","infoPii","verbosePii","RequestType","ResponseType","TokenRenewStatus","Adal","options","LOGIN","name","url","RegExp","test","regex","replace","urlNavigation","frameName","resource","saveItem","RENEW_STATUS","InProgress","_loadFrame","setTimeout","config","loadFrameTimeout","expectedState","_activeRenewals","_callBackMappedToRenewStates","Canceled","urlNavigate","_user","profile","sid","indexOf","_urlContainsQueryStringParameter","encodeURIComponent","upn","parts","split","length","_adalInstance","popUp","instance","loginResource","clientId","laodFrameTimeout","expireOffsetSeconds","anonymousEndpoints","navigateToLoginRequestUrl","tenant","redirectUri","location","href","callback","logger","login","_loginInProgress","guid","loginStartPage","state","_idTokenNonce","LOGIN_REQUEST","LOGIN_ERROR","STATE_LOGIN","NONCE_IDTOKEN","ERROR","ERROR_DESCRIPTION","_getNavigateUrl","displayCall","_renewStates","push","registerCallback","_loginPopup","promptUser","_openPopup","title","popUpWidth","popUpHeight","left","innerWidth","screenX","top","innerHeight","screenY","popupWindow","open","focus","e","_acquireTokenInProgress","_handlePopupError","loginCallback","errorDesc","loginError","_openedWindows","registeredRedirectUri","pollTimer","setInterval","closed","undefined","clearInterval","popUpWindowLocation","encodeURI","handleWindowCallback","hash","close","loginInProgress","_hasResource","key","keys","TOKEN_KEYS","isEmpty","getCachedToken","token","ACCESS_TOKEN_KEY","expiry","EXPIRATION_KEY","now","getCachedUser","idtoken","IDTOKEN","_createUser","_callBacksMappedToRenewStates","tokenType","i","_renewToken","responseType","frameHandle","_addAdalFrame","_urlRemoveQueryStringParameter","ID_TOKEN","_addHintParameters","src","_loadFrameTimeout","_renewIdToken","acquireToken","extraQueryParameter","_requestType","RENEW_TOKEN","acquireTokenPopup","extraQueryParameters","claims","ensureCanAcquireToken","acquireTokenRedirect","STATE_RENEW","clearCache","SESSION_STATE","clearCacheForResource","logOut","logOutUri","logout","postLogoutRedirectUri","getUser","idToken","json","_extractIdToken","has","aud","toLowerCase","userName","email","getLoginError","getRequestInfo","requestInfo","valid","parameters","stateMatch","stateResponse","requestType","UNKNOWN","deserialize","getHash","hasOwnProperty","_matchState","parent","_matchNonce","user","requestNonce","nonce","loginStates","acquireTokenStates","saveTokenFromHash","splitIndex","substring","getResourceFromState","error_description","_expiresIn","exp","Completed","getResourceForEndpoint","endpoint","endpoints","configEndpoint","_getHostFromUri","uri","String","isCallback","self","isPopup","opener","tokenReceivedCallback","err","_serialize","encodedIdToken","decodedToken","_decodeJwt","base64Decoded","_base64DecodeStringUrlSafe","JWSPayload","JSON","parse","base64IdToken","decodeURIComponent","escape","atob","jwtToken","matches","exec","header","JWSSig","_convertUrlSafeToRegularBase64EncodedString","str","obj","slice","join","expires","parseInt","iframeId","adalFrame","document","getElementById","createElement","documentElement","navigator","userAgent","ifr","setAttribute","style","visibility","position","width","height","borderWidth","getElementsByTagName","appendChild","body","insertAdjacentHTML","frames","value","preserve","old","query","match","pl","search","decode","s","Object","call","Math","round","cryptoObj","crypto","msCrypto","buffer","Uint8Array","getRandomValues","map","n","hex","toString"],"mappings":"IAAYA,GAAZ,SAAYA,GACRA,+BACAA,2CACAA,uCACAA,iCACAA,iCACAA,qCACAA,qCACAA,2BACAA,yBACAA,qBACAA,6CACAA,qCACAA,iCACAA,yCAdJ,CAAYA,IAAAA,aAsBCC,EAAoB,MAC7B,SAASC,EAAgBC,GACrB,MAAMC,EAAUC,OAAOF,GACvB,QAAKC,IAILA,EAAQE,QADQ,WAAA,YAAA,aAEZF,EAAQG,QAFI,cAKhBH,EAAQI,WALQ,aAMZJ,EAAQG,QANI,cAYpB,OAAIL,EAAgB,gBAAwBO,aACxCP,EAAgB,kBAA0BQ,eACvC,CAACH,YAAcD,cApBO,OCpBrBK,GAAZ,SAAYA,GACRA,qBACAA,mBACAA,mBACAA,yBAJJ,CAAYA,IAAAA,OAOZ,MAAMC,EAAmB,CACrBC,CAACF,EAASG,OAAQ,QAClBD,CAACF,EAASI,MAAO,UACjBF,CAACF,EAASK,MAAO,OACjBH,CAACF,EAASM,SAAU,WAGxB,MAAaC,EAAbC,cACIC,UAAM,EAENA,WAAQT,EAASG,MAQjBO,IACIC,EACAC,EACAC,EACAC,GAAc,GAEd,KAAIA,GAAgBL,KAAKM,MAErBJ,GAASF,KAAKE,MAAO,CACrB,IACIK,GADY,IAAIC,MAAOC,cAGvB,KACCT,KAAKU,cAAgBV,KAAKU,cAAgB,IAAM,IAFjDC,UAKAnB,EAAiBU,GACjB,KACAC,EAEAC,IAEAG,GAAoB,aAAeH,EAAMQ,OAG7CC,QAAQZ,IAAIM,IASpBH,MAAMD,EAAiBC,GACnBJ,KAAKC,IAAIV,EAASG,MAAOS,EAASC,GAOtCU,KAAKX,GACDH,KAAKC,IAAIV,EAASI,KAAMQ,EAAS,MAOrCY,KAAKZ,GACDH,KAAKC,IAAIV,EAASK,KAAMO,EAAS,MAOrCa,QAAQb,GACJH,KAAKC,IAAIV,EAASM,QAASM,EAAS,MAQxCc,SAASd,EAAiBC,GACtBJ,KAAKC,IAAIV,EAASG,MAAOS,EAASC,GAAO,GAO7Cc,QAAQf,GACJH,KAAKC,IAAIV,EAASI,KAAMQ,EAAS,MAAM,GAO3CgB,QAAQhB,GACJH,KAAKC,IAAIV,EAASK,KAAMO,EAAS,MAAM,GAO3CiB,WAAWjB,GACPH,KAAKC,IAAIV,EAASM,QAASM,EAAS,MAAM,QCjG7CkB,EAKAC,EAKAC,GAVL,SAAKF,GACDA,gBACAA,4BACAA,oBAHJ,CAAKA,IAAAA,OAKL,SAAKC,GACDA,4BACAA,gBAFJ,CAAKA,IAAAA,OAKL,SAAKC,GACDA,sBACAA,wBACAA,2BAHJ,CAAKA,IAAAA,OAiBL,MAAaC,EAgBTzB,YAAY0B,GACR,GAfJzB,YAAS,IAAIF,EAKbE,qBAAuB,GACvBA,uBAAmB,EACnBA,8BAA0B,EAC1BA,kBAAsB,GACtBA,oBAAwB,GACxBA,kCAAoC,GACpCA,mCAAqC,GACrCA,kBAAeqB,EAAYK,MAqY3B1B,sCAAmC,SAAU2B,EAAMC,GAG/C,OADY,IAAIC,OAAO,SAAWF,EAAO,KAC5BG,KAAKF,IAOtB5B,oCAAiC,SAAU4B,EAAKD,GAG5C,IAAII,EAAQ,IAAIF,OAAO,OAASF,EAAO,WAQvC,OAPAC,EAAMA,EAAII,QAAQD,EAAO,IAEzBA,EAAQ,IAAIF,OAAO,IAAMF,EAAO,YAChCC,EAAMA,EAAII,QAAQD,EAAO,IAEzBA,EAAQ,IAAIF,OAAO,IAAMF,EAAO,WAC1BC,EAAII,QAAQD,EAAO,KAS7B/B,uBAAoB,SAAUiC,EAAeC,EAAWC,GAEpDnC,KAAKgB,QAAQ,qCAAuCmB,GACpDC,EACIxD,EAAWyD,aAAeF,EAC1BZ,EAAiBe,YAErBtC,KAAKuC,WAAWN,EAAeC,GAE/BM,WAAW,KACP,GACIrD,EAAQP,EAAWyD,aAAeF,KAClCZ,EAAiBe,WACnB,CAEEtC,KAAKgB,QACD,sCACIhB,KAAKyC,OAAOC,iBAAmB,IAC/B,yBACAP,GAER,IAAIQ,EAAgB3C,KAAK4C,gBAAgBT,GAGrCQ,GACA3C,KAAK6C,6BAA6BF,IAElC3C,KAAK6C,6BAA6BF,GAC9B,gDACA,KACA,wBAIRP,EACIxD,EAAWyD,aAAeF,EAC1BZ,EAAiBuB,YAG1B9C,KAAKyC,OAAOC,mBA+SnB1C,wBAAqB,SAAU+C,GAK3B,GAAI/C,KAAKgD,OAAShD,KAAKgD,MAAMC,QACzB,GACIjD,KAAKgD,MAAMC,QAAQC,MACsB,IAAzCH,EAAYI,QAAQ,gBAIfnD,KAAKoD,iCAAiC,MAAOL,KAG9CA,GACI,QAAUM,mBAAmBrD,KAAKgD,MAAMC,QAAQC,cAEjDlD,KAAKgD,MAAMC,QAAQK,MAGrBtD,KAAKoD,iCACF,aACAL,KAIJA,GACI,eACAM,mBAAmBrD,KAAKgD,MAAMC,QAAQK,OAIzCtD,KAAKoD,iCACF,cACAL,IAEJ/C,KAAKgD,MAAMC,QAAQK,IAAIH,QAAQ,MAAQ,GACzC,CACE,IAAII,EAAQvD,KAAKgD,MAAMC,QAAQK,IAAIE,MAAM,KAEzCT,GACI,gBACAM,mBAAmBE,EAAMA,EAAME,OAAS,IAKxD,OAAOV,GAryBF9D,OAAeyE,cAChB,OAAQzE,OAAeyE,cAE3B1D,KAAKyC,OAAS,CACVkB,OAAO,EACPC,SAAU,qCACVC,cAAepC,EAAQqC,SACvBC,iBAAkB,IAClBC,oBAAqB,IACrBC,mBAAoB,GACpBC,2BAA2B,EAC3BC,OAAQ,SACRC,YAAanF,OAAOoF,SAASC,KAAKd,MAAM,KAAK,GAAGA,MAAM,KAAK,GAC3De,SAAU,UACP9C,GAEPzB,KAAKwE,OAAO9D,cAAgBe,EAAQf,cAClCzB,OAAeyE,cAAgB1D,KAMrCyE,QACI,GAAIzE,KAAK0E,iBAEL,YADA1E,KAAKwE,OAAOzD,KAAK,qBAIrBf,KAAK0E,kBAAmB,EAGxB,MAAM/B,EAAgBgC,IAChBC,EAAiB3F,OAAOoF,SAASC,KACvCtE,KAAKyC,OAAOoC,MAAQlC,EACpB3C,KAAK8E,cAAgBH,IAErB3E,KAAKwE,OAAOxD,QACR,mBAAqB2B,EAAgB,cAAgBiC,GAEzDxC,EAASxD,EAAWmG,cAAeH,GACnCxC,EAASxD,EAAWoG,YAAa,IACjC5C,EAASxD,EAAWqG,YAAatC,GAAe,GAChDP,EAASxD,EAAWsG,cAAelF,KAAK8E,eAAe,GACvD1C,EAASxD,EAAWuG,MAAO,IAC3B/C,EAASxD,EAAWwG,kBAAmB,IACvC,IAAIrC,EACA/C,KAAKqF,gBAAgB,YACrB,UACAhC,mBAAmBrD,KAAK8E,eAExB9E,KAAKyC,OAAO6C,YAEZtF,KAAKyC,OAAO6C,YAAYvC,GACjB/C,KAAKyC,OAAOkB,OACnBvB,EAASxD,EAAWqG,YAAa,IACjCjF,KAAKuF,aAAaC,KAAK7C,GACvB3C,KAAKyF,iBACD9C,EACA3C,KAAKyC,OAAOqB,SACZ9D,KAAKyC,OAAO8B,UAEhBvE,KAAK0F,YAAY3C,IAEjB/C,KAAK2F,WAAW5C,GAQxB6C,WACI7C,EACA8C,EACAC,EACAC,GAEA,IACI,MAAMC,EAAO/G,OAAOgH,WAAa,EAAIH,EAAa,EAAI7G,OAAOiH,QACvDC,EACFlH,OAAOmH,YAAc,EAAIL,EAAc,EAAI9G,OAAOoH,QAChDC,EAAcrH,OAAOsH,KACvBxD,EACA8C,EACA,SACIC,EACA,YACAC,EACA,SACAI,EACA,UACAH,GAOR,OAJIM,EAAYE,OACZF,EAAYE,QAGTF,EACT,MAAOG,GAIL,OAHAzG,KAAKwE,OAAO1D,KAAK,wBAA0B2F,EAAEtG,SAC7CH,KAAK0E,kBAAmB,EACxB1E,KAAK0G,yBAA0B,QAKvCC,kBACIC,EACAzE,EACA/B,EACAyG,EACAC,GAEA9G,KAAKwE,OAAO1D,KAAK+F,GACjBzE,EAASxD,EAAWuG,MAAO/E,GAC3BgC,EAASxD,EAAWwG,kBAAmByB,GACvCzE,EAASxD,EAAWoG,YAAa8B,GAE7B3E,GAAYnC,KAAK4C,gBAAgBT,KACjCnC,KAAK4C,gBAAgBT,GAAY,MAGrCnC,KAAK0E,kBAAmB,EACxB1E,KAAK0G,yBAA0B,EAE3BE,GACAA,EAAcC,EAAW,KAAMzG,GASvCsF,YAAY3C,EAAqBZ,EAAmBoC,GAChD,IAAI+B,EAActG,KAAK4F,WAAW7C,EAAa,QAAS,IAAK,KACzD6D,EAAgBrC,GAAYvE,KAAKyC,OAAO8B,SAE5C,IAAK+B,EAAa,CACd,IACIO,EACA,4DAQJ,YAPA7G,KAAK2G,kBACDC,EACAzE,EALQ,sBAOR0E,EACAA,GAKR7G,KAAK+G,eAAevB,KAAKc,GACzB,MAAMU,EAAwBhH,KAAKyC,OAAO2B,YAAYZ,MAAM,KAAK,GAEjE,IAAIyD,EAAYC,YAAY,KACxB,IACKZ,GACDA,EAAYa,aACWC,IAAvBd,EAAYa,OACd,CACE,IACIN,EACA,0GAUJ,OARA7G,KAAK2G,kBACDC,EACAzE,EANQ,sBAQR0E,EACAA,QAEJQ,cAAcJ,GAGlB,IACI,IAAIK,EAAsBhB,EAAYjC,SACtC,IAGU,GAFNkD,UAAUD,EAAoBhD,MAAMnB,QAChCoE,UAAUP,IAUd,OAPAhH,KAAKwH,qBAAqBF,EAAoBG,MAC9CJ,cAAcJ,GACdjH,KAAK0E,kBAAmB,EACxB1E,KAAK0G,yBAA0B,EAC/B1G,KAAKwE,OAAOzD,KAAK,wBACjBf,KAAK+G,eAAiB,QACtBT,EAAYoB,QAGlB,MAAOjB,MACV,GAGPkB,kBACI,YAAYjD,iBAQhBkD,aAAaC,GACT,IAAIC,EAAO3I,EAAQP,EAAWmJ,YAC9B,OAAQC,EAAQF,IAASA,EAAK3E,QAAQ0E,EAvOrB,MAuOkD,EAQvEI,eAAe9F,GACX,IAAKnC,KAAK4H,aAAazF,GACnB,YAGJ,MAAM+F,EAAQ/I,EAAQP,EAAWuJ,iBAAmBhG,GAC9CiG,EAASjJ,EAAQP,EAAWyJ,eAAiBlG,GAEnD,OAAIiG,GAAUA,EAASE,IAAQtI,KAAKyC,OAAOuB,oBAChCkE,GAEP9F,EAASxD,EAAWuJ,iBAAmBhG,EAAU,IACjDC,EAASxD,EAAWyJ,eAAiBlG,EAAU,SAgBvDoG,gBACI,GAAIvI,KAAKgD,MACL,YAAYA,MAGhB,IAAIwF,EAAUrJ,EAAQP,EAAW6J,SAEjC,OADAzI,KAAKgD,MAAQhD,KAAK0I,YAAYF,QAClBxF,MAShByC,iBAAiB9C,EAAoBR,EAAkBoC,GACnDvE,KAAK4C,gBAAgBT,GAAYQ,EAE5B3C,KAAK2I,8BAA8BhG,KACpC3C,KAAK2I,8BAA8BhG,GAAiB,IAGxD3C,KAAK2I,8BAA8BhG,GAAe6C,KAAKjB,GAElDvE,KAAK6C,6BAA6BF,KACnC3C,KAAK6C,6BAA6BF,GAAiB,CAC/CkE,EACAqB,EACA9H,EACAwI,KAEA5I,KAAK4C,gBAAgBT,GAAY,KAEjC,IACI,IAAI0G,EAAI,EACRA,EACA7I,KAAK2I,8BAA8BhG,GAAec,SAChDoF,EAEF,IACI7I,KAAK2I,8BAA8BhG,GAAekG,GAC9ChC,EACAqB,EACA9H,EACAwI,GAEN,MAAOxI,GACLJ,KAAKwE,OAAO1D,KAAKV,GAIzBJ,KAAK2I,8BAA8BhG,GAAiB,KACpD3C,KAAK6C,6BAA6BF,GAAiB,OAa/DmG,YAAY3G,EAAUoC,EAAUwE,EAAe,SAG3C/I,KAAKwE,OAAOzD,KAAK,qCAAuCoB,GACxD,IAAI6G,EAAchJ,KAAKiJ,cAAc,iBAAmB9G,GACpDQ,EAAgBgC,IAlVH,IAkViCxC,EAClDnC,KAAKyC,OAAOoC,MAAQlC,EAEpB3C,KAAKuF,aAAaC,KAAK7C,GACvB3C,KAAKwE,OAAOxD,QAAQ,+BAAiC2B,GAErD,IAAII,EAAc/C,KAAKkJ,+BACnBlJ,KAAKqF,gBAAgB0D,EAAc5G,GACnC,UAGA4G,IAAiBzH,EAAa6H,WAC9BnJ,KAAK8E,cAAgBH,IACrBvC,EAASxD,EAAWsG,cAAelF,KAAK8E,eAAe,GACvD/B,GAAe,UAAYM,mBAAmBrD,KAAK8E,gBAIvD/B,EAAc/C,KAAKoJ,mBADnBrG,GAA4B,gBAE5B/C,KAAKyF,iBAAiB9C,EAAeR,EAAUoC,GAC/CvE,KAAKwE,OAAOpD,WAAW,eAAiB2B,GAExCiG,EAAYK,IAAM,cAClBrJ,KAAKsJ,kBACDvG,EACA,iBAAmBZ,EACnBA,GAQRoH,cAAchF,EAAUwE,GAEpB/I,KAAKwE,OAAOzD,KAAK,0BACjB,IAAIiI,EAAchJ,KAAKiJ,cAAc,oBACjCtG,EAAgBgC,IAxXH,IAwXiC3E,KAAKyC,OAAOqB,SAC9D9D,KAAK8E,cAAgBH,IACrBvC,EAASxD,EAAWsG,cAAelF,KAAK8E,eAAe,GACvD9E,KAAKyC,OAAOoC,MAAQlC,EAEpB3C,KAAKuF,aAAaC,KAAK7C,GACvB3C,KAAKwE,OAAOxD,QAAQ,iCAAmC2B,GAEvD,IAAIR,EAAW4G,GAAgB/I,KAAKyC,OAAOqB,SAEvCf,EAAc/C,KAAKkJ,+BACnBlJ,KAAKqF,gBAFT0D,EAAeA,GAAgB,WAEQ5G,GACnC,UAEJY,GAA4B,eAC5BA,EAAc/C,KAAKoJ,mBAAmBrG,GACtCA,GAAe,UAAYM,mBAAmBrD,KAAK8E,eACnD9E,KAAKyF,iBAAiB9C,EAAe3C,KAAKyC,OAAOqB,SAAUS,GAC3DvE,KAAKwE,OAAOpD,WAAW,eAAiB2B,GAExCiG,EAAYK,IAAM,cAClBrJ,KAAKsJ,kBACDvG,EACA,mBACA/C,KAAKyC,OAAOqB,UAmFpBvB,WAAWQ,EAAab,GAGpBlC,KAAKwE,OAAOzD,KAAK,cAAgBmB,GACjCM,WAAW,KACP,IAAIwG,EAAchJ,KAAKiJ,cAAc/G,GACb,KAApB8G,EAAYK,KAAkC,gBAApBL,EAAYK,MACtCL,EAAYK,IAAMtG,EAClB/C,KAAKuC,WAAWQ,EAAab,KAElC,KAePsH,aAAarH,EAAUoC,GACnB,IAAKpC,EAAU,CACX,MAAM/B,EAAQ,uBAGd,OAFAJ,KAAKwE,OAAO1D,KAAKV,QACjBmE,EAASnE,EAAO,KAAMA,GAI1B,IAAI8H,EAAQlI,KAAKiI,eAAe9F,GAEhC,GAAI+F,EAKA,OAJAlI,KAAKwE,OAAOzD,KACR,0CAA4CoB,QAEhDoC,EAAS,KAAM2D,EAAO,MAI1B,KACKlI,KAAKgD,OAEFhD,KAAKyC,OAAOgH,sBAC+C,IAA3DzJ,KAAKyC,OAAOgH,oBAAoBtG,QAAQ,eAE9C,CACE,MAAM/C,EAAQ,yBAGd,OAFAJ,KAAKwE,OAAO1D,KAAKV,QACjBmE,EAASnE,EAAO,KAAMA,GAMtBJ,KAAK4C,gBAAgBT,GAErBnC,KAAKyF,iBACDzF,KAAK4C,gBAAgBT,GACrBA,EACAoC,IAGJvE,KAAK0J,aAAerI,EAAYsI,YAC5BxH,IAAanC,KAAKyC,OAAOqB,SAGrB9D,KAAKgD,OACLhD,KAAKwE,OAAOxD,QAAQ,oBACpBhB,KAAKuJ,cAAchF,KAEnBvE,KAAKwE,OAAOxD,QAAQ,qCACpBhB,KAAKuJ,cAAchF,EAAUjD,EAAa6H,WAG1CnJ,KAAKgD,OACLhD,KAAKwE,OAAOxD,QAAQ,yBACpBhB,KAAK8I,YAAY3G,EAAUoC,KAE3BvE,KAAKwE,OAAOxD,QAAQ,qCACpBhB,KAAK8I,YAAY3G,EAAUoC,EAAUjD,EAAa6H,YAYlES,kBAAkBzH,EAAU0H,EAAsBC,EAAQvF,GACtD,GAAKvE,KAAK+J,sBAAsB5H,GAAhC,CAIA,IAAIQ,EAAgBgC,IAvkBH,IAukBiCxC,EAClDnC,KAAKyC,OAAOoC,MAAQlC,EACpB3C,KAAKuF,aAAaC,KAAK7C,GACvB3C,KAAK0J,aAAerI,EAAYsI,YAChC3J,KAAKwE,OAAOxD,QAAQ,+BAAiC2B,GAErD,IAAII,EAAc/C,KAAKkJ,+BACnBlJ,KAAKqF,gBAAgB,QAASlD,GAC9B,UAQJ,GANAY,GAA4B,yBAExB8G,IACA9G,GAAe8G,GAGfC,IAA8C,IAApC/G,EAAYI,QAAQ,WAC9BJ,GAAe,WAAaM,mBAAmByG,WACxCA,IAA8C,IAApC/G,EAAYI,QAAQ,WACrC,UAAUzD,MAAM,qDAGpBqD,EAAc/C,KAAKoJ,mBAAmBrG,GACtC/C,KAAK0G,yBAA0B,EAC/B1G,KAAKwE,OAAOzD,KACR,uDAAyDoB,GAE7DnC,KAAKyF,iBAAiB9C,EAAeR,EAAUoC,GAC/CvE,KAAK0F,YAAY3C,EAAaZ,EAAUoC,IAS5CyF,qBAAqB7H,EAAU0H,EAAsBC,GACjD,IAAK9J,KAAK+J,sBAAsB5H,GAC5B,OAGJ,MAAMQ,EAAgBgC,IAjnBL,IAinBmCxC,EACpDnC,KAAKyC,OAAOoC,MAAQlC,EACpB3C,KAAKwE,OAAOxD,QAAQ,+BAAiC2B,GAGrD,IAAII,EAAc/C,KAAKkJ,+BACnBlJ,KAAKqF,gBAAgB,QAASlD,GAC9B,UAOJ,GALAY,GAA4B,yBACxB8G,IACA9G,GAAe8G,GAGfC,IAA8C,IAApC/G,EAAYI,QAAQ,WAC9BJ,GAAe,WAAaM,mBAAmByG,WACxCA,IAA8C,IAApC/G,EAAYI,QAAQ,WACrC,UAAUzD,MAAM,qDAGpBqD,EAAc/C,KAAKoJ,mBAAmBrG,GACtC/C,KAAK0G,yBAA0B,EAC/B1G,KAAKwE,OAAOzD,KACR,uDAAyDoB,GAE7DC,EAASxD,EAAWmG,cAAe9F,OAAOoF,SAASC,MACnDlC,EAASxD,EAAWqL,YAAatH,GAAe,GAChD3C,KAAK2F,WAAW5C,GAIpBgH,sBAAsB5H,GAClB,IAAI/B,EAQJ,OAPK+B,EAEOnC,KAAKgD,MAENhD,KAAK0G,0BACZtG,EAAQ,oDAFRA,EAAQ,yBAFRA,EAAQ,wBAMRA,IACAJ,KAAKwE,OAAO1D,KAAKV,GACjBJ,KAAKyC,OAAO8B,SACRnE,EACA,KACAA,OAWZuF,WAAW5C,GACHA,GACA/C,KAAKwE,OAAOrD,QAAQ,eAAiB4B,GACrC9D,OAAOoF,SAASrC,QAAQe,IAExB/C,KAAKwE,OAAOzD,KAAK,yBAOzBmJ,aACI9H,EAASxD,EAAWmG,cAAe,IACnC3C,EAASxD,EAAWuL,cAAe,IACnC/H,EAASxD,EAAWqG,YAAa,IACjC7C,EAASxD,EAAWqL,YAAa,IACjCjK,KAAKuF,aAAe,GACpBnD,EAASxD,EAAWsG,cAAe,IACnC9C,EAASxD,EAAW6J,QAAS,IAC7BrG,EAASxD,EAAWuG,MAAO,IAC3B/C,EAASxD,EAAWwG,kBAAmB,IACvChD,EAASxD,EAAWoG,YAAa,IACjC5C,EAASxD,EAAWoG,YAAa,IACjC,IAAI8C,EAAO3I,EAAQP,EAAWmJ,YAE9B,IAAKC,EAAQF,GAAO,CAChBA,EAAOA,EAAKtE,MApsBC,KAqsBb,IAAK,IAAIqF,EAAI,EAAGA,EAAIf,EAAKrE,QAAsB,KAAZqE,EAAKe,GAAWA,IAC/CzG,EAASxD,EAAWuJ,iBAAmBL,EAAKe,GAAI,IAChDzG,EAASxD,EAAWyJ,eAAiBP,EAAKe,GAAI,GAItDzG,EAASxD,EAAWmJ,WAAY,IAOpCqC,sBAAsBjI,GAClBC,EAASxD,EAAWqL,YAAa,IACjC7H,EAASxD,EAAWuG,MAAO,IAC3B/C,EAASxD,EAAWwG,kBAAmB,IAEnCpF,KAAK4H,aAAazF,KAClBC,EAASxD,EAAWuJ,iBAAmBhG,EAAU,IACjDC,EAASxD,EAAWyJ,eAAiBlG,EAAU,IAQvDkI,SAGI,IAAItH,EAEJ,GAJA/C,KAAKkK,aACLlK,KAAKgD,MAAQ,KAGThD,KAAKyC,OAAO6H,UACZvH,EAAc/C,KAAKyC,OAAO6H,cACvB,CACH,IAAIC,EAAS,GACTvK,KAAKyC,OAAO+H,wBACZD,EACI,4BACAlH,mBAAmBrD,KAAKyC,OAAO+H,wBAGvCzH,EACI/C,KAAKyC,OAAOmB,SACZ5D,KAAKyC,OAAO0B,OACZ,kBACAoG,EAGRvK,KAAKwE,OAAOrD,QAAQ,uBAAyB4B,GAC7C/C,KAAK2F,WAAW5C,GAGpB0H,UACI,GAAIzK,KAAKgD,MACL,YAAYA,MAGhB,MAAM0H,EAAUvL,EAAQP,EAAW6J,SACnC,OAAIiC,OACY1H,MAAQhD,KAAK0I,YAAYgC,QADzC,EAiEJhC,YAAYgC,GACR,MAAMC,EAAO3K,KAAK4K,gBAAgBF,GAClC,GAAKG,EAAIF,EAAM,OAIf,OAAIA,EAAKG,IAAIC,gBAAkB/K,KAAKyC,OAAOqB,SAASiH,cAGzC,CACHC,SAAUL,EAAKrH,KAAOqH,EAAKM,MAC3BhI,QAAS0H,QAJb3K,KAAKwE,OAAO1D,KAAK,iCAazBoK,gBACI,OAAO/L,EAAQP,EAAWoG,aAiB9BmG,eAAe1D,GACX,MAAM2D,EAAc,CAChBC,OAAO,EACPC,WAAY,GACZC,YAAY,EACZC,cAAe,GACfC,YAAapK,EAAYqK,SAGvBJ,EAAaK,EAAYC,EAAQnE,IACvC,IAAK6D,EACD,OAAOF,EAIX,GADAA,EAAYE,WAAaA,EAErBT,EAAIS,EA13BQ,sBA23BZT,EAAIS,EA/3BK,iBAg4BTT,EAAIS,EA93BD,YA+3BL,CAIE,GAHAF,EAAYC,OAAQ,GAGhBC,EAAWO,eAAe,SAK1B,OADA7L,KAAKwE,OAAO1D,KAAK,qBACVsK,EAKX,GATIpL,KAAKwE,OAAOxD,QAAQ,UAAYsK,EAAWzG,OAC3CuG,EAAYI,cAAgBF,EAAWzG,MAQvC7E,KAAK8L,YAAYV,GAEjB,OAAOA,EAIX,IAAKA,EAAYG,YAActM,OAAO8M,OAAQ,CAC1CX,EAAYK,YAAczL,KAAK0J,aAC/B,IAAK,MAAM7E,UAAcU,aACrB,GAAIV,IAAUuG,EAAYI,cAAe,CACrCJ,EAAYG,YAAa,EACzB,QAKhB,OAAOH,EAOXY,YAAYC,GACR,MAAMC,EAAe/M,EAAQP,EAAWsG,eACxC,GAAIgH,EACA,IAAK,MAAMC,KAASD,EAAa1I,MAl6BvB,MAm6BN,GAAI2I,IAAUF,EAAKhJ,QAAQkJ,MACvB,SAIZ,SAOJL,YAAYV,GACR,MAAMgB,EAAcjN,EAAQP,EAAWqG,aACvC,GAAImH,EACA,IAAK,MAAMvH,KAASuH,EAAY5I,MAl7BtB,MAm7BN,GAAIqB,IAAUuG,EAAYI,cAGtB,OAFAJ,EAAYK,YAAcpK,EAAYK,MACtC0J,EAAYG,YAAa,KAMrC,MAAMc,EAAqBlN,EAAQP,EAAWqL,aAC9C,GAAIoC,EACA,IAAK,MAAMxH,KAASwH,EAAmB7I,MA77B7B,MA87BN,GAAIqB,IAAUuG,EAAYI,cAGtB,OAFAJ,EAAYK,YAAcpK,EAAYsI,YACtCyB,EAAYG,YAAa,KAMrC,SAMJe,kBAAkBlB,GACdpL,KAAKwE,OAAOzD,KACR,gBACIqK,EAAYG,WACZ,kBACAH,EAAYK,aAEpBrJ,EAASxD,EAAWuG,MAAO,IAC3B/C,EAASxD,EAAWwG,kBAAmB,IAEvC,IAmCY0C,EAnCR3F,EAqhBZ,SAA8B0C,GAC1B,GAAIA,EAAO,CACP,IAAI0H,EAAa1H,EAAM1B,QA9+CN,KA++CjB,GAAIoJ,GAAc,GAAKA,EAAa,EAAI1H,EAAMpB,OAC1C,OAAOoB,EAAM2H,UAAUD,EAAa,GAI5C,MAAO,GA7hBYE,CAAqBrB,EAAYI,eAG5CJ,EAAYE,WAAWO,eA59BX,sBA69BZ7L,KAAKwE,OAAOrD,QACR,UACIiK,EAAYE,WAAWlL,MACvB,uBACAgL,EAAYE,WAAZ,mBAERlJ,EAASxD,EAAWuG,MAAOiG,EAAYE,WAAWlL,OAClDgC,EACIxD,EAAWwG,kBACXgG,EAAYE,WAAZ,mBAGAF,EAAYK,cAAgBpK,EAAYK,QACxC1B,KAAK0E,kBAAmB,EACxBtC,EACIxD,EAAWoG,YACXoG,EAAYE,WAAWoB,qBAK3BtB,EAAYG,YAEZvL,KAAKwE,OAAOzD,KAAK,kBACbqK,EAAYE,WAAWO,eAp/BvB,kBAq/BAzJ,EACIxD,EAAWuL,cACXiB,EAAYE,WAAZ,eAMJF,EAAYE,WAAWO,eAlgCtB,kBAmgCD7L,KAAKwE,OAAOzD,KAAK,6BAEZf,KAAK4H,aAAazF,KACnB2F,EAAO3I,EAAQP,EAAWmJ,aAAe,GACzC3F,EACIxD,EAAWmJ,WACXD,EAAO3F,EAngCV,MAwgCLC,EACIxD,EAAWuJ,iBAAmBhG,EAC9BiJ,EAAYE,WAAZ,cAEJlJ,EACIxD,EAAWyJ,eAAiBlG,EAC5BnC,KAAK2M,WAAWvB,EAAYE,WAAZ,cAIpBF,EAAYE,WAAWO,eAthC5B,cAwhCK7L,KAAK0E,kBAAmB,EACxB1E,KAAKgD,MAAQhD,KAAK0I,YACd0C,EAAYE,WAAZ,UAEAtL,KAAKgD,OAAShD,KAAKgD,MAAMC,QACpBjD,KAAKgM,YAAYhM,KAAKgD,QAUvBZ,EACIxD,EAAW6J,QACX2C,EAAYE,WAAZ,UAQCtL,KAAK4H,aAJVzF,EAAWnC,KAAKyC,OAAOoB,cACjB7D,KAAKyC,OAAOoB,cACZ7D,KAAKyC,OAAOqB,YAGdgE,EAAO3I,EAAQP,EAAWmJ,aAAe,GACzC3F,EACIxD,EAAWmJ,WACXD,EAAO3F,EAjjClB,MAqjCGC,EACIxD,EAAWuJ,iBAAmBhG,EAC9BiJ,EAAYE,WAAZ,UAEJlJ,EACIxD,EAAWyJ,eAAiBlG,EAC5BnC,KAAKgD,MAAMC,QAAQ2J,OAjCvBxK,EACIxD,EAAWoG,YACX,mBACIhF,KAAKgD,MAAMC,QAAQkJ,MACnB,8BACAhN,EAAQP,EAAWsG,gBAE3BlF,KAAKgD,MAAQ,OA8BjBoI,EAAYE,WAAZ,MAAkC,mBAClCF,EAAYE,WAAZ,kBACI,+BACAF,EAAYE,WAAZ,SACJlJ,EAASxD,EAAWuG,MAAO,oBAC3B/C,EACIxD,EAAWwG,kBACX,+BACIgG,EAAYE,WAAZ,cAKhBF,EAAYE,WAAZ,MAAkC,gBAClCF,EAAYE,WAAZ,kBACI,yBAA2BF,EAAYI,cAC3CpJ,EAASxD,EAAWuG,MAAO,iBAC3B/C,EACIxD,EAAWwG,kBACX,yBAA2BgG,EAAYI,gBAKnDpJ,EAASxD,EAAWyD,aAAeF,EAAUZ,EAAiBsL,WAQlEC,uBAAuBC,GAEnB,GAAI/M,KAAKyC,QAAUzC,KAAKyC,OAAOwB,mBAC3B,IAAK,IAAI4E,EAAI,EAAGA,EAAI7I,KAAKyC,OAAOwB,mBAAmBR,OAAQoF,IACvD,GAAIkE,EAAS5J,QAAQnD,KAAKyC,OAAOwB,mBAAmB4E,KAAO,EACvD,YAKZ,GAAI7I,KAAKyC,QAAUzC,KAAKyC,OAAOuK,UAC3B,IAAK,IAAIC,UAAuBxK,OAAOuK,UAEnC,GAAID,EAAS5J,QAAQ8J,IAAmB,EACpC,YAAYxK,OAAOuK,UAAUC,GAQzC,OACIF,EAAS5J,QAAQ,YAAc,GAC/B4J,EAAS5J,QAAQ,aAAe,EAG5BnD,KAAKkN,gBAAgBH,KACrB/M,KAAKkN,gBAAgBlN,KAAKyC,OAAO2B,kBAErB3B,OAAOoB,wBAKXpB,OAAOoB,cAW3BqJ,gBAAgBC,GAIZ,OAFmBC,OAAOD,GAAKnL,QAAQ,iBAAkB,IAC7BwB,MAAM,KAAK,GAQ3CgE,qBAAqBC,GAOjB,GAJY,MAARA,IACAA,EAAOxI,OAAOoF,SAASoD,MA+SnC,SAAoBA,GAChB,MAAM6D,EAAaK,EAAYC,EAAQnE,IACvC,OACIoD,EAAIS,EAh9CY,sBAi9ChBT,EAAIS,EAr9CS,iBAs9CbT,EAAIS,EAp9CG,YAmqCH+B,CAAW5F,GAAO,CAClB,IAAI6F,EAAa,KACbC,GAAU,EAGVvN,KAAK+G,eAAetD,OAAS,GAC7BzD,KAAK+G,eAAe/G,KAAK+G,eAAetD,OAAS,GAAG+J,QACpDxN,KAAK+G,eAAe/G,KAAK+G,eAAetD,OAAS,GAAG+J,OAC/C9J,eAEL4J,EAAOtN,KAAK+G,eAAe/G,KAAK+G,eAAetD,OAAS,GACnD+J,OAAO9J,cACZ6J,GAAU,GAGLtO,OAAO8M,QAAU9M,OAAO8M,OAAOrI,gBAEpC4J,EAAOrO,OAAO8M,OAAOrI,eAGzB,IACI+J,EAYAvF,EACAU,EAdAwC,EAAckC,EAAKnC,eAAe1D,GAIlCgG,EADAF,GAAWtO,OAAO8M,SAAW9M,OAEzBqO,EAAKzK,6BAA6BuI,EAAYI,eAE1B8B,EAAK7K,OAAO8B,SAIxC+I,EAAKhB,kBAAkBlB,GAKnBA,EAAYK,cAAgBpK,EAAYsI,aACxC1K,OAAO8M,QAEH9M,OAAO8M,SAAW9M,OAClBqO,EAAK9I,OAAOxD,QACR,iDAGJsM,EAAK9I,OAAOxD,QACR,2CAIRkH,EACIkD,EAAYE,WAAZ,cACAF,EAAYE,WAAZ,SACJ1C,EAztCK,gBA0tCEwC,EAAYK,cAAgBpK,EAAYK,QAC/CwG,EAAQkD,EAAYE,WAAZ,SACR1C,EA1tCD,YA6tCH,IAAI/B,EAAYuE,EAAYE,WAAZ,kBACZlL,EAAQgL,EAAYE,WAAZ,MACZ,IACQmC,GACAA,EAAsB5G,EAAWqB,EAAO9H,EAAOwI,GAErD,MAAO8E,GACLJ,EAAK9I,OAAOpE,MACR,qDAAuDsN,GAI3DzO,OAAO8M,SAAW9M,QAAWsO,IACzBD,EAAK7K,OAAOyB,0BACZjF,OAAOoF,SAASC,KAAOnF,EAAQP,EAAWmG,eAE1C9F,OAAOoF,SAASoD,KAAO,KAUvCpC,gBAAgB0D,EAAsB5G,GAClC,MAAMY,EACF/C,KAAKyC,OAAOmB,SACZ5D,KAAKyC,OAAO0B,OACZ,oBACAnE,KAAK2N,WAAW5E,EAAc/I,KAAKyC,OAAQN,GAH3CnC,uCAOJ,OADAA,KAAKwE,OAAOzD,KAAK,gBAAkBgC,GAC5BA,EAOX6H,gBAAgBgD,GAEZ,IAAIC,EAAe7N,KAAK8N,WAAWF,GAEnC,GAAKC,EAIL,IACI,IACIE,EAAgB/N,KAAKgO,2BADLH,EAAaI,YAGjC,OAAKF,EAQEG,KAAKC,MAAMJ,QAPd/N,KAAKwE,OAAOzD,KACR,+DAOV,MAAO2M,GACL1N,KAAKwE,OAAOpE,MAAM,6CAA8CsN,IAQxEM,2BAA2BI,GAEvB,OADAA,EAAgBA,EAAcpM,QAAQ,KAAM,KAAKA,QAAQ,KAAM,KACxDqM,mBAAmBC,OAAOrP,OAAOsP,KAAKH,KAQjDN,WAAWU,GACP,GAAIxG,EAAQwG,GACR,YAGJ,IAEIC,EAFoB,uCAEQC,KAAKF,GAErC,OAAKC,GAAWA,EAAQhL,OAAS,GAC7BzD,KAAKwE,OAAO1D,KAAK,iDAIF,CACf6N,OAAQF,EAAQ,GAChBR,WAAYQ,EAAQ,GACpBG,OAAQH,EAAQ,IAUxBI,4CAA4CC,GACxC,OAAOA,EAAI9M,QAAQ,IAAK,KAAKA,QAAQ,IAAK,KAO9C2L,WAAW5E,EAAsBgG,EAAU5M,GACvC,IAAI2M,EAAgB,GAEpB,GAAY,OAARC,EAAc,CACdD,EAAItJ,KAAK,kBAAoBuD,GAC7B+F,EAAItJ,KAAK,aAAenC,mBAAmB0L,EAAIjL,WAC3C3B,GACA2M,EAAItJ,KAAK,YAAcnC,mBAAmBlB,IAG9C2M,EAAItJ,KAAK,gBAAkBnC,mBAAmB0L,EAAI3K,cAClD0K,EAAItJ,KAAK,SAAWnC,mBAAmB0L,EAAIlK,QAEvCkK,EAAIlD,eAAe,UACnBiD,EAAItJ,KAAK,SAAWnC,mBAAmB0L,EAAIC,QAG3CD,EAAIlD,eAAe,wBACnBiD,EAAItJ,KAAKuJ,EAAItF,qBAGjB,IAAI/I,EAAgBqO,EAAIrO,cAAgBqO,EAAIrO,cAAgBiE,IAC5DmK,EAAItJ,KAAK,qBAAuBnC,mBAAmB3C,IAGvD,OAAOoO,EAAIG,KAAK,KAOpBtC,WAAWuC,GAGP,OADKA,IAASA,EAAU,MACjB5G,IAAQ6G,SAASD,EAAS,IAOrCjG,cAAcmG,GACV,GAAKA,EAAL,CAIApP,KAAKwE,OAAOzD,KAAK,8BAAgCqO,GACjD,IAAIC,EAAYC,SAASC,eAAeH,GAExC,IAAKC,EAAW,CACZ,GACIC,SAASE,eACTF,SAASG,kBACRxQ,OAAM,QACiD,IAApDA,OAAOyQ,UAAUC,UAAUxM,QAAQ,aACzC,CACE,IAAIyM,EAAMN,SAASE,cAAc,UACjCI,EAAIC,aAAa,KAAMT,GACvBQ,EAAIC,aAAa,cAAe,QAChCD,EAAIE,MAAMC,WAAa,SACvBH,EAAIE,MAAME,SAAW,WACrBJ,EAAIE,MAAMG,MAAQL,EAAIE,MAAMI,OAASN,EAAIO,YAAc,MAEvDd,EAAYC,SACPc,qBAAqB,QAAQ,GAC7BC,YAAYT,QACVN,SAASgB,MAAQhB,SAASgB,KAAKC,oBACtCjB,SAASgB,KAAKC,mBACV,YACA,iBACInB,EACA,SACAA,EACA,oCAGRnQ,OAAOuR,QAAUvR,OAAOuR,OAAOpB,KAC/BC,EAAYpQ,OAAOuR,OAAOpB,IAIlC,OAAOC,IAQf,SAASjN,EAASyF,EAAa4I,EAAYC,GAAW,GAClD,GAAIA,EAAU,CACV,MAAMC,EAAMxR,EAAQ0I,IAAQ,GAC5BhJ,EAAQK,QAAQ2I,EAAK8I,EAAMF,EA16Cb,WA46Cd5R,EAAQK,QAAQ2I,EAAK4I,GAQ7B,SAAStR,EAAQ0I,GACb,OAAOhJ,EAAQM,QAAQ0I,GAO3B,SAAS+D,EAAQnE,GAMb,OALIA,EAAKtE,QAAQ,OAAS,EACtBsE,EAAOA,EAAK+E,UAAU/E,EAAKtE,QAAQ,MAAQ,GACpCsE,EAAKtE,QAAQ,MAAQ,IAC5BsE,EAAOA,EAAK+E,UAAU,IAEnB/E,EAqBX,SAASkE,EAAYiF,GACjB,IAAIC,EACAC,EAAK,MACLC,EAAS,oBACTC,EAAUC,GAAc5C,mBAAmB4C,EAAEjP,QAAQ8O,EAAI,MACzD/B,EAAM,GAGV,IAFA8B,EAAQE,EAAOrC,KAAKkC,GAEbC,GACH9B,EAAIiC,EAAOH,EAAM,KAAOG,EAAOH,EAAM,IACrCA,EAAQE,EAAOrC,KAAKkC,GAGxB,OAAO7B,EAkBX,SAAS/G,EAAQ8G,GACb,YAAsB,IAARA,IAAwBA,GAAO,IAAMA,EAAIrL,OAG3D,SAASoH,EAAIkE,EAAUlH,GACnB,QAASkH,GAAOmC,OAAOrF,eAAesF,KAAKpC,EAAKlH,GAGpD,SAASS,IACL,OAAO8I,KAAKC,MAAM7Q,KAAK8H,MAAQ,KAOnC,SAAS3D,IAsBL,IAAI2M,EAAYrS,OAAOsS,QAAUtS,OAAOuS,SACpCC,EAAS,IAAIC,WAAW,IAe5B,OAdAJ,EAAUK,gBAAgBF,GAE1BA,EAAO,IAAM,GACbA,EAAO,IAAM,GAEbA,EAAO,IAAM,IACbA,EAAO,IAAM,KACbA,EAASA,EAAOG,IAAKC,IACjB,IAAIC,EAAMD,EAAEE,SAAS,IACrB,KAAOD,EAAIrO,OAAS,GAChBqO,EAAM,IAAMA,EAEhB,OAAOA,KAGA,GACPL,EAAO,GACPA,EAAO,GACPA,EAAO,GACP,IACAA,EAAO,GACPA,EAAO,GACP,IACAA,EAAO,GACPA,EAAO,GACP,IACAA,EAAO,GACPA,EAAO,GACP,IACAA,EAAO,IACPA,EAAO,IACPA,EAAO,IACPA,EAAO,IACPA,EAAO,IACPA,EAAO"}